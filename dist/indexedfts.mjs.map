{"version":3,"file":"indexedfts.mjs","sources":["../lib/utils.js","../lib/errors.js","../lib/IFTSArrayPromise.js","../lib/IFTSTransaction.js","../lib/IndexedFTS.js","../lib/IFTSSchema.js"],"sourcesContent":["/**\n * Splitting text to n-gram\n *\n * @ignore\n */\nexport function splitText(text, ngram=2) {\n\tconst result = [];\n\tfor (let i=0; i<text.length-ngram+1; i++) {\n\t\tresult.push(text.slice(i, i+ngram));\n\t}\n\treturn result;\n}\n\n\n/**\n * Splitting text to words\n *\n * @ignore\n */\nexport function splitWords(text) {\n\treturn dedup(text.split(/\\s+/).filter(x => x.length > 0));\n}\n\n\n/**\n * Make n-gram set by text.\n *\n * @ignore\n */\nexport function tokenize(text, ngram=2) {\n\treturn dedup(splitText(text, ngram));\n}\n\n\n/**\n * Parse queries.\n *\n * @ignore\n */\nexport function splitQuery(query, ngram=2) {\n\tconst result = {};\n\tquery.split(/\\s+/).filter(q => q.length > 0).forEach(q => result[q] = tokenize(q, ngram));\n\treturn result;\n}\n\n\n/**\n * Deduplication from Array\n *\n * @ignore\n */\nexport function dedup(array) {\n\tconst result = new Array(array.length);\n\tconst index = new Set();\n\tlet idx = 0;\n\n\tfor (let i=0; i<array.length; i++) {\n\t\tif (!index.has(array[i])) {\n\t\t\tindex.add(array[i]);\n\t\t\tresult[idx] = array[i];\n\t\t\tidx++;\n\t\t}\n\t}\n\n\treturn result.slice(0, idx);\n}\n\n\n/**\n * Faster Array.prototype.map\n *\n * @ignore\n */\nexport function fastMap(array, fun) {\n\tconst result = new Array(array.length);\n\tfor (let i=0; i<array.length; i++) {\n\t\tresult[i] = fun(array[i]);\n\t}\n\treturn result;\n}\n\n\n/**\n * Flatten nested array\n *\n * @ignore\n */\nexport function flatten(array) {\n\tlet length = 0;\n\tfor (let i=0; i<array.length; i++) {\n\t\tlength += array[i].length;\n\t}\n\n\tconst result = new Array(length);\n\tlet idx = 0;\n\tfor (let i=0; i<array.length; i++) {\n\t\tfor (let j=0; j<array[i].length; j++) {\n\t\t\tresult[idx] = array[i][j];\n\t\t\tidx++;\n\t\t}\n\t}\n\n\treturn result;\n}\n","/**\n * NoSuchColumnError means specified no indexed column.\n */\nexport class NoSuchColumnError extends Error {\n\t/**\n\t * @param {object} column - name of errored column.\n\t */\n\tconstructor(column) {\n\t\tsuper(column + ': no such column or no indexed');\n\n\t\t/**\n\t\t * Column name that errored.\n\t\t *\n\t\t * @type {object}\n\t\t */\n\t\tthis.column = column;\n\n\t\t/** @ignore */\n\t\tthis.name = '';\n\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, NoSuchColumnError);\n\t\t}\n\t}\n}\n\n\n/**\n * InvalidKeyError means specified invalid key.\n */\nexport class InvalidKeyError extends Error {\n\t/**\n\t * @param {object} key - name of specified key.\n\t */\n\tconstructor(key) {\n\t\tsuper('invalid key');\n\n\t\t/**\n\t\t * Key name that specified.\n\t\t *\n\t\t * @type {object}\n\t\t */\n\t\tthis.key = key;\n\n\t\t/** @ignore */\n\t\tthis.name = '';\n\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, InvalidKeyError);\n\t\t}\n\t}\n}\n\n\n/**\n * InvalidSchemaError means specified invalid schema.\n */\nexport class InvalidSchemaError extends Error {\n\t/**\n\t * @param {string} reason - why throws this error.\n\t * @param {string|string[]|null} column - name of column that invalid.\n\t */\n\tconstructor(reason, column=null) {\n\t\tsuper(reason);\n\n\t\t/**\n\t\t * Name of column that invalid.\n\t\t *\n\t\t * @type {string|string[]|null}\n\t\t */\n\t\tthis.column = column;\n\n\t\t/** @ignore */\n\t\tthis.name = 'InvalidSchemaError';\n\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, InvalidSchemaError);\n\t\t}\n\t}\n}\n","import {splitQuery, splitWords} from './utils';\nimport {NoSuchColumnError} from './errors';\n\n\n/**\n * Promise like object for contents array.\n *\n * Almost methods are the same interface as {@link IndexedFTS} and {@link IFTSTransaction}.\n * But this class will processing all contents without using indexes.\n * Please consider using {@link IFTSTransaction} directly if it can.\n */\nexport default class IFTSArrayPromise {\n\t/**\n\t * @param {Set<string>} indexes - index names.\n\t * @param {Promise<object[]>} promise - Promise for wrapping.\n\t */\n\tconstructor(indexes, promise) {\n\t\t/** @type {Set<string>} */\n\t\tthis.indexes = indexes;\n\n\t\t/** @type {Promise<object[]>} */\n\t\tthis.promise = promise;\n\t}\n\n\t/**\n\t * Make resolved promise.\n\t *\n\t * @param {Set<string>} indexes - index names.\n\t * @param {object[]} value - value for promise.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tstatic resolve(indexes, value=[]) {\n\t\treturn new IFTSArrayPromise(indexes, Promise.resolve(value));\n\t}\n\n\t/**\n\t * Make rejected promise.\n\t *\n\t * @param {Set<string>} indexes - index names.\n\t * @param {object} value - value for promise.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tstatic reject(indexes, value=null) {\n\t\treturn new IFTSArrayPromise(indexes, Promise.reject(value));\n\t}\n\n\t/**\n\t * Set next function.\n\t *\n\t * @param {function(contents: object[]): *} fun - next function.\n\t *\n\t * @return {Promise}\n\t */\n\tthen(fun) {\n\t\treturn this.promise.then(fun);\n\t}\n\n\t/**\n\t * Set error handling function.\n\t *\n\t * @param {function(error: *): *} fun - error handling function.\n\t *\n\t * @return {Promise}\n\t */\n\tcatch(fun) {\n\t\treturn this.promise.catch(fun);\n\t}\n\n\t/**\n\t * Do something process for each elements and make a new IFTSArrayPromise.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for processing element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tmap(fun) {\n\t\treturn new IFTSArrayPromise(this.indexes, this.then(xs => xs.map(fun)));\n\t}\n\n\t/**\n\t * Filtering elements by function and make a new IFTSArrayPromise.\n\t *\n\t * @param {function(content: object, index: Number): boolean} fun - function for filtering element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tfilter(fun) {\n\t\treturn new IFTSArrayPromise(this.indexes, this.then(xs => xs.filter(fun)));\n\t}\n\n\t/**\n\t * Sort contents.\n\t *\n\t * @param {object} column - the column for sorting.\n\t * @param {'asc'|'desc'} [order='asc'] - sort order.\n\t * @param {Number} [offset=0] - starting offset of the result.\n\t * @param {Number} [limit] - maximum number of result length. will unlimited if omitted.\n\t *\n\t * @return {IFTSArrayPromise} sorted contents.\n\t */\n\tsort(column, order='asc', offset=0, limit=undefined) {\n\t\tif (!this.indexes.has(column)) {\n\t\t\treturn IFTSArrayPromise.reject(this.indexes, new NoSuchColumnError(column));\n\t\t}\n\n\t\treturn new IFTSArrayPromise(this.indexes, this.then(xs => Array.prototype.concat.call([], xs).sort((x, y) => {\n\t\t\tif (x[column] < y[column]) {\n\t\t\t\treturn order === 'desc' ? 1 : -1;\n\t\t\t} else if (x[column] > y[column]) {\n\t\t\t\treturn order === 'desc' ? -1 : 1;\n\t\t\t} else {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t}).slice(offset, limit === undefined ? undefined : offset + limit)));\n\t}\n\n\t/**\n\t * Checking index of column are exists and do {@link IFTSArrayPromise#filter}.\n\t *\n\t * @ignore\n\t */\n\t_checkAndFilter(column, fun) {\n\t\tif (!this.indexes.has(column)) {\n\t\t\treturn IFTSArrayPromise.reject(this.indexes, new NoSuchColumnError(column));\n\t\t}\n\n\t\treturn this.filter(fun);\n\t}\n\n\t/**\n\t * Get contents that have fully matched property.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tequals(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] === value);\n\t}\n\n\t/**\n\t * Get contents that have property lower than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlower(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] < value);\n\t}\n\n\t/**\n\t * Get contents that have property greater than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreater(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] > value);\n\t}\n\n\t/**\n\t * Get contents that have property lower than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlowerOrEquals(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] <= value);\n\t}\n\n\t/**\n\t * Get contents that have property greater than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreaterOrEquals(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] >= value);\n\t}\n\n\t/**\n\t * Get contents that have property is between argument values.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} lower - minimal value.\n\t * @param {object} upper - maximum value.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tbetween(column, lower, upper) {\n\t\treturn this._checkAndFilter(column, x => lower <= x[column] && x[column] <= upper);\n\t}\n\n\t/**\n\t * Get contents that have matched property by full-text search.\n\t *\n\t * This method can search even if didn't made ngram index.\n\t *\n\t * WARNING: This method always processes all contents without using indexes.\n\t * Please consider using {@link IFTSTransaction#search}.\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents.\n\t */\n\tsearch(columns, query) {\n\t\tif (typeof columns === 'string') {\n\t\t\tcolumns = [columns];\n\t\t}\n\n\t\tfor (let c of columns) {\n\t\t\tif (!this.indexes.has(c)) {\n\t\t\t\treturn IFTSArrayPromise.reject(this.indexes, new NoSuchColumnError(c));\n\t\t\t}\n\t\t}\n\n\t\tconst queries = [];\n\t\tfor (let q in splitQuery(query)) {\n\t\t\tqueries.push(q);\n\t\t}\n\n\t\treturn this.filter(data => queries.every(q => columns.some(col => data[col].includes(q))));\n\t}\n\n\t/**\n\t * Find contents that have fully matched word in property.\n\t *\n\t * This method can search even if didn't made word index.\n\t *\n\t * WARNING: This method always processes all contents without using indexes.\n\t * Please consider using {@link IFTSTransaction#searchWord}.\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearchWord(columns, query) {\n\t\tif (typeof columns === 'string') {\n\t\t\tcolumns = [columns];\n\t\t}\n\n\t\tfor (let c of columns) {\n\t\t\tif (!this.indexes.has(c)) {\n\t\t\t\treturn IFTSArrayPromise.reject(this.indexes, new NoSuchColumnError(c));\n\t\t\t}\n\t\t}\n\n\t\tconst queries = splitWords(query);\n\n\t\treturn this.filter(data => queries.every(q => columns.some(col => {\n\t\t\treturn splitWords(data[col]).includes(q);\n\t\t})));\n\t}\n}\n","import {tokenize, splitQuery, splitWords, fastMap, flatten, dedup} from './utils';\nimport {NoSuchColumnError, InvalidKeyError} from './errors';\nimport IFTSArrayPromise from './IFTSArrayPromise';\n\n\n/**\n * Transaction.\n *\n * Almost methods are the same interface as {@link IndexedFTS} and {@link IFTSArrayPromise}.\n * Probably this class is faster than other classes in most cases.\n *\n * Please be careful, IFTSTransaction are sometimes makes a big cache.\n * Should not keep many transactions if not need.\n */\nexport default class IFTSTransaction {\n\t/**\n\t * @param {IndexedFTS} db - database.\n\t * @param {IDBTransaction} transaction - transaction of IndexedDB.\n\t */\n\tconstructor(db, transaction) {\n\t\t/** @type {IndexedDB} */\n\t\tthis.db = db;\n\n\t\t/** @type {IDBTransaction} */\n\t\tthis.transaction = transaction;\n\n\t\t/** @ignore */\n\t\tthis._KeyRange = this.db.scope.IDBKeyRange;\n\n\t\t/**\n\t\t * Promise for await closing transaction.\n\t\t *\n\t\t * @type {Promise<IndexedDB>}\n\t\t */\n\t\tthis.promise = new Promise((resolve, reject) => {\n\t\t\tthis.transaction.oncomplete = () => resolve(this.db);\n\t\t\tthis.transaction.onerror = err => reject(err);\n\t\t});\n\n\t\t/** @ignore */\n\t\tthis._cache = {};\n\t}\n\n\t/**\n\t * Put contents into database.\n\t *\n\t * @param {object} contents - contents for save. allowed multiple arguments.\n\t *\n\t * @return {Promise<IFTSTransaction>} returns self for chain.\n\t */\n\tput(...contents) {\n\t\tconst store = this.transaction.objectStore('data');\n\t\tconst ngram_indexes = fastMap([...this.db.ngram_indexes], column => ({name: column, store: this.transaction.objectStore(this.db.index_prefix + 'ngram_' + column)}));\n\t\tconst word_indexes = fastMap([...this.db.word_indexes], column => ({name: column, store: this.transaction.objectStore(this.db.index_prefix + 'word_' + column)}));\n\n\t\tconst putPromises = new Array(contents.length);\n\t\tfor (let i=0; i<contents.length; i++) {\n\t\t\tputPromises[i] = new Promise((resolve, reject) => {\n\t\t\t\tconst req = store.put(contents[i]);\n\t\t\t\treq.onerror = reject;\n\t\t\t\treq.onsuccess = ev => {\n\t\t\t\t\tresolve(\n\t\t\t\t\t\tthis._updateNGramIndex(ev.target.result, contents[i], ngram_indexes)\n\t\t\t\t\t\t\t.then(() => this._updateWordIndex(ev.target.result, contents[i], word_indexes)))\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\treturn Promise.all(putPromises).then(data => {\n\t\t\tfor (let i=0; i<data.length; i++) {\n\t\t\t\tconst key = data[i][0];\n\t\t\t\tconst value = data[i][1];\n\t\t\t\tif (this.db.primary_key === null) {\n\t\t\t\t\tvalue._key = key;\n\t\t\t\t}\n\t\t\t\tthis._cache[key] = value;\n\t\t\t}\n\t\t\treturn this;\n\t\t});\n\t}\n\n\t/**\n\t * Update ngram index.\n\t *\n\t * @ignore\n\t */\n\t_updateNGramIndex(key, data, ngram_indexes) {\n\t\treturn this._deleteIndex(key, ngram_indexes.map(x => this.db.index_prefix + 'ngram_' + x.name))\n\t\t\t.then(() => Promise.all(fastMap(ngram_indexes, col => {\n\t\t\t\tconst tokens = tokenize(data[col.name]);\n\t\t\t\tconst promises = new Array(tokens.length);\n\t\t\t\tfor (let i=0; i<tokens.length; i++) {\n\t\t\t\t\tpromises[i] = new Promise((resolve, reject) => {\n\t\t\t\t\t\tconst req = col.store.put({\n\t\t\t\t\t\t\tkey: key,\n\t\t\t\t\t\t\ttoken: tokens[i],\n\t\t\t\t\t\t});\n\t\t\t\t\t\treq.onsuccess = () => resolve();\n\t\t\t\t\t\treq.onerror = reject;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn Promise.all(promises);\n\t\t\t})))\n\t\t\t.then(() => [key, data]);\n\t}\n\n\t/**\n\t * Update word index.\n\t *\n\t * @ignore\n\t */\n\t_updateWordIndex(key, data, word_indexes) {\n\t\treturn this._deleteIndex(key, word_indexes.map(x => this.db.index_prefix + 'word_' + x.name))\n\t\t\t.then(() => Promise.all(fastMap(word_indexes, col => {\n\t\t\t\tconst words = splitWords(data[col.name]);\n\t\t\t\tconst promises = new Array(words.length);\n\t\t\t\tfor (let i=0; i<words.length; i++) {\n\t\t\t\t\tpromises[i] = new Promise((resolve, reject) => {\n\t\t\t\t\t\tconst req = col.store.put({\n\t\t\t\t\t\t\tkey: key,\n\t\t\t\t\t\t\tword: words[i],\n\t\t\t\t\t\t});\n\t\t\t\t\t\treq.onsuccess = () => resolve();\n\t\t\t\t\t\treq.onerror = reject;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn Promise.all(promises);\n\t\t\t})))\n\t\t\t.then(() => [key, data]);\n\t}\n\n\t/**\n\t * Delete content by FTS indexes of database.\n\t *\n\t * @ignore\n\t */\n\t_deleteIndex(key, tableNames) {\n\t\treturn Promise.all(tableNames.map(table => {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst store = this.transaction.objectStore(table);\n\t\t\t\tstore.onerror = reject;\n\n\t\t\t\tconst requests = [];\n\n\t\t\t\tconst req = store.index('key').openKeyCursor(this._KeyRange.only(key));\n\t\t\t\treq.onerror = reject;\n\t\t\t\treq.onsuccess = ev => {\n\t\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\t\tif (cursor) {\n\t\t\t\t\t\trequests.push(new Promise((resolve, reject) => {\n\t\t\t\t\t\t\tconst d = store.delete(cursor.primaryKey);\n\t\t\t\t\t\t\td.onsuccess = resolve;\n\t\t\t\t\t\t\td.onerror = reject\n\t\t\t\t\t\t}));\n\t\t\t\t\t\tcursor.continue();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(Promise.all(requests));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}));\n\t}\n\n\t/**\n\t * Delete contents from database.\n\t *\n\t * @param {object} keys - key of contents. allowed multiple arguments.\n\t *\n\t * @return {Promise<IFTSTransaction>} returns self for chain. Will reject with {@link InvalidKeyError} if keys included null or undefined.\n\t */\n\tdelete(...keys) {\n\t\tfor (let i=0; i<keys.length; i++) {\n\t\t\tif (keys[i] === null || keys[i] === undefined) {\n\t\t\t\treturn Promise.reject(new InvalidKeyError(keys[i]));\n\t\t\t}\n\t\t}\n\n\t\treturn Promise.all(fastMap(keys, key => {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst req = this.transaction.objectStore('data').delete(key);\n\t\t\t\treq.onerror = reject;\n\t\t\t\treq.onsuccess = resolve;\n\t\t\t})\n\t\t\t.then(() => this._deleteIndex(key, [\n\t\t\t\t...[...this.db.ngram_indexes].map(x => this.db.index_prefix + 'ngram_' + x),\n\t\t\t\t...[...this.db.word_indexes].map(x => this.db.index_prefix + 'word_' + x),\n\t\t\t]))\n\t\t})).then(() => this);\n\t}\n\n\t/**\n\t * Make {@link IFTSArrayPromise} by cursor.\n\t *\n\t * @ignore\n\t */\n\t_readCursor(cursorRequest, filter=null, map=null, limit=undefined) {\n\t\tfilter = filter || ((x, i) => true);\n\t\tmap = map || ((x, i) => x);\n\n\t\treturn new IFTSArrayPromise(this.db.indexes, new Promise((resolve, reject) => {\n\t\t\tconst result = [];\n\t\t\tlet index = 0;\n\n\t\t\tcursorRequest.onsuccess = ev => {\n\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\tif (cursor) {\n\t\t\t\t\tconst value = cursor.value;\n\t\t\t\t\tif (this.db.primary_key === null) {\n\t\t\t\t\t\tvalue._key = cursor.key;\n\t\t\t\t\t}\n\t\t\t\t\tthis._cache[cursor.key] = value;\n\t\t\t\t\tif (filter(value, index)) {\n\t\t\t\t\t\tresult.push(map(value, index));\n\t\t\t\t\t}\n\n\t\t\t\t\tindex++;\n\t\t\t\t\tif (limit === undefined || index < limit) {\n\t\t\t\t\t\tcursor.continue();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(result);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t};\n\t\t\tcursorRequest.onerror = err => reject(err);\n\t\t}));\n\t}\n\n\t/**\n\t * Get all contents.\n\t *\n\t * @return {IFTSArrayPromise} contents.\n\t */\n\tgetAll() {\n\t\treturn this._readCursor(this.transaction.objectStore('data').openCursor());\n\t}\n\n\t/**\n\t * Get all contents with primary keys.\n\t *\n\t * @ignore\n\t */\n\t_getAllWithKeys() {\n\t\treturn new IFTSArrayPromise(this.db.indexes, new Promise((resolve, reject) => {\n\t\t\tconst request = this.transaction.objectStore('data').openCursor();\n\n\t\t\tconst result = [];\n\t\t\trequest.onsuccess = ev => {\n\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\tif (cursor) {\n\t\t\t\t\tconst value = cursor.value;\n\t\t\t\t\tif (this.db.primary_key === null) {\n\t\t\t\t\t\tvalue._key = cursor.key;\n\t\t\t\t\t}\n\t\t\t\t\tthis._cache[cursor.key] = value;\n\t\t\t\t\tresult.push({key: cursor.key, data: value});\n\t\t\t\t\tcursor.continue();\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\trequest.onerror = err => reject(err);\n\t\t}));\n\t}\n\n\t/**\n\t * Do something process for each elements and returns {@link IFTSArrayPromise}.\n\t *\n\t * NOTE: This method doesn't fast. May better do filtering before doing map if need filtering.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for processing element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tmap(fun) {\n\t\treturn this._readCursor(this.transaction.objectStore('data').openCursor(null), null, fun);\n\t}\n\n\t/**\n\t * Filtering elements by function and returns {@link IFTSArrayPromise}.\n\t *\n\t * WARNING: This method won't use the index. Other methods(eg. {@link IFTSTransaction#equals} or {@link IFTSTransaction#lower} may faster than this.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for filtering element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tfilter(fun) {\n\t\treturn this._readCursor(this.transaction.objectStore('data').openCursor(null), fun, null);\n\t}\n\n\t/**\n\t * Sort and get all contents.\n\t *\n\t * @param {object} column - the column for sorting.\n\t * @param {'asc'|'desc'} [order='asc'] - sort order.\n\t * @param {Number} [offset=0] - starting offset of the result.\n\t * @param {Number} [limit] - maximum number of result length. will unlimited if omitted.\n\t *\n\t * @return {IFTSArrayPromise} sorted contents.\n\t */\n\tsort(column, order='asc', offset=0, limit=undefined) {\n\t\tif (!this.db.indexes.has(column)) {\n\t\t\treturn IFTSArrayPromise.reject(this.db.indexes, new NoSuchColumnError(column));\n\t\t}\n\n\t\tlimit = limit === undefined ? undefined : offset + limit;\n\t\tconst offsetFilter = (x, i) => offset <= i;\n\n\t\tconst store = this.transaction.objectStore('data');\n\n\t\tif (column === this.db.primary_key) {\n\t\t\treturn this._readCursor(store.openCursor(null, order === 'desc' ? 'prev' : 'next'), offsetFilter, null, limit);\n\t\t} else {\n\t\t\treturn this._readCursor(store.index(column).openCursor(null, order === 'desc' ? 'prev' : 'next'), offsetFilter, null, limit);\n\t\t}\n\t}\n\n\t/**\n\t * Get content by primary key.\n\t *\n\t * @param {object} key - the key of content.\n\t *\n\t * @return {Promise<object|undefined>} content. promise will reject with {@link InvalidKeyError} if keys included null or undefined. result value will be undefined if not found.\n\t */\n\tget(key) {\n\t\tif (key === null || key === undefined) {\n\t\t\treturn Promise.reject(new InvalidKeyError(key));\n\t\t}\n\t\tif (key in this._cache) {\n\t\t\treturn Promise.resolve(this._cache[key]);\n\t\t}\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst req = this.transaction.objectStore('data').get(key);\n\t\t\treq.onsuccess = ev => {\n\t\t\t\tconst value = ev.target.result;\n\t\t\t\tif (this.db.primary_key === null) {\n\t\t\t\t\tvalue._key = key;\n\t\t\t\t}\n\t\t\t\tthis._cache[key] = value;\n\t\t\t\tresolve(value);\n\t\t\t};\n\t\t\treq.onerror = reject;\n\t\t});\n\t}\n\n\t/**\n\t * Get contents matched keyRange.\n\t *\n\t * @ignore\n\t */\n\t_getAllWithIndex(column, keyRange) {\n\t\tif (!this.db.indexes.has(column)) {\n\t\t\treturn IFTSArrayPromise.reject(this.db.indexes, new NoSuchColumnError(column));\n\t\t}\n\n\t\tconst store = this.transaction.objectStore('data');\n\n\t\tif (column === this.db.primary_key) {\n\t\t\treturn this._readCursor(store.openCursor(keyRange));\n\t\t} else {\n\t\t\treturn this._readCursor(store.index(column).openCursor(keyRange));\n\t\t}\n\t}\n\n\t/**\n\t * Get contents that have fully matched property.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tequals(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.only(value));\n\t}\n\n\t/**\n\t * Get contents that have property lower than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlower(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.upperBound(value, true));\n\t}\n\n\t/**\n\t * Get contents that have property greater than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreater(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.lowerBound(value, true));\n\t}\n\n\t/**\n\t * Get contents that have property lower than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlowerOrEquals(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.upperBound(value, false));\n\t}\n\n\t/**\n\t * Get contents that have property greater than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreaterOrEquals(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.lowerBound(value, false));\n\t}\n\n\t/**\n\t * Get contents that have property is between argument values.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} lower - minimal value.\n\t * @param {object} upper - maximum value.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tbetween(column, lower, upper) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.bound(lower, upper, false, false));\n\t}\n\n\t/**\n\t * Get candidates of search result.\n\t *\n\t * @ignore\n\t */\n\t_takeCandidatesBySingleColumn(column, queries) {\n\t\tconst index = this.transaction.objectStore(this.db.index_prefix + 'ngram_' + column).index('token');\n\t\tconst result = [];\n\n\t\tfor (let q in queries) {\n\t\t\tif (queries[q].length === 0) {\n\t\t\t\tresult.push(this._getAllWithKeys().filter(x => x.data[column].includes(q)).map(x => x.key).then(xs => ({query: q, keys: xs})));\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst promises = new Array(queries[q].length);\n\t\t\tfor (let i=0; i<queries[q].length; i++) {\n\t\t\t\tpromises[i] = this._readCursor(index.openCursor(queries[q][i]), null, data => data.key);\n\t\t\t}\n\n\t\t\tconst candidate = Promise.all(promises)\n\t\t\t\t.then(founds => {\n\t\t\t\t\tif (founds.length === 0) {\n\t\t\t\t\t\treturn Promise.resolve([]);\n\t\t\t\t\t}\n\n\t\t\t\t\tfounds = flatten(founds);\n\n\t\t\t\t\tconst deduped = new Array(founds.length);\n\t\t\t\t\tlet dedup_num = 0;\n\t\t\t\t\tconst hit_count = {};\n\t\t\t\t\tfor (let i=0; i<founds.length; i++) {\n\t\t\t\t\t\tif (!(founds[i] in hit_count)) {\n\t\t\t\t\t\t\thit_count[founds[i]] = 0;\n\n\t\t\t\t\t\t\tdeduped[dedup_num] = founds[i];\n\t\t\t\t\t\t\tdedup_num++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\thit_count[founds[i]]++;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst candidates = new Array(dedup_num);\n\t\t\t\t\tlet candidate_num = 0;\n\t\t\t\t\tfor (let i=0; i<dedup_num; i++) {\n\t\t\t\t\t\tif (hit_count[deduped[i]] >= queries[q].length) {\n\t\t\t\t\t\t\tcandidates[candidate_num] = this.get(deduped[i]).then(data => ({key: deduped[i], data: data}));\n\t\t\t\t\t\t\tcandidate_num++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn Promise.all(candidates.slice(0, candidate_num));\n\t\t\t\t})\n\t\t\t\t.then(xs => ({query: q, keys: xs.filter(x => x.data[column].includes(q)).map(x => x.key)}))\n\n\t\t\tresult.push(candidate);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Prune contents by result of {@link IFTSTransaction#_takeCandidatesBySingleColumn}.\n\t *\n\t * @ignore\n\t */\n\tasync _pruneCandidates(queries_num, candidates) {\n\t\tconst keys = {};\n\n\t\tfor (let i=0; i<candidates.length; i++) {\n\t\t\tfor (let j=0; j<candidates[i].keys.length; j++) {\n\t\t\t\tif (!(candidates[i].keys[j] in keys)) {\n\t\t\t\t\tkeys[candidates[i].keys[j]] = new Set();\n\t\t\t\t}\n\t\t\t\tkeys[candidates[i].keys[j]].add(candidates[i].query);\n\t\t\t}\n\t\t}\n\n\t\tconst result = new Array(candidates.length);\n\t\tlet result_num = 0;\n\t\tfor (let key in keys) {\n\t\t\tif (keys[key].size == queries_num) {\n\t\t\t\tresult[result_num] = this.get(key);\n\t\t\t\tresult_num++;\n\t\t\t}\n\t\t}\n\n\t\treturn await Promise.all(result.slice(0, result_num));\n\t}\n\n\t/**\n\t * Get contents that have matched property by full-text search.\n\t *\n\t * All target columns have to made ngram index when created database.\n\t * If you didn't made ngram index, you can use {@link IFTSArrayPromise#search} (but this way is very slow).\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearch(columns, query) {\n\t\tif (typeof columns === 'string') {\n\t\t\tcolumns = [columns];\n\t\t}\n\n\t\tfor (let i=0; i<columns.length; i++) {\n\t\t\tif (!this.db.ngram_indexes.has(columns[i])) {\n\t\t\t\treturn IFTSArrayPromise.reject(this.db.indexes, new NoSuchColumnError(columns[i]));\n\t\t\t}\n\t\t}\n\n\t\tconst queries = splitQuery(query);\n\t\tlet queries_length = 0;\n\n\t\tfor (let q in queries) {\n\t\t\tqueries[q] = fastMap(queries[q], x => this._KeyRange.only(x));\n\t\t\tqueries_length++;\n\t\t}\n\n\t\tconst candidatePromises = [];\n\n\t\tfor (let i=0; i<columns.length; i++) {\n\t\t\tArray.prototype.push.apply(candidatePromises, this._takeCandidatesBySingleColumn(columns[i], queries));\n\t\t}\n\n\t\treturn new IFTSArrayPromise(\n\t\t\tthis.db.indexes,\n\t\t\tPromise.all(candidatePromises).then(xs => this._pruneCandidates(queries_length, xs)),\n\t\t);\n\t}\n\n\t/**\n\t * Find contents that have fully matched word in property.\n\t *\n\t * All target columns have to made word index when created database.\n\t * If you didn't made word index, you can use {@link IFTSArrayPromise#searchWord} (but this way is very slow).\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearchWord(columns, query) {\n\t\tif (typeof columns === 'string') {\n\t\t\tcolumns = [columns];\n\t\t}\n\n\t\tfor (let i=0; i<columns.length; i++) {\n\t\t\tif (!this.db.word_indexes.has(columns[i])) {\n\t\t\t\treturn IFTSArrayPromise.reject(this.db.indexes, new NoSuchColumnError(columns[i]));\n\t\t\t}\n\t\t}\n\n\t\tconst queries = splitWords(query).map(x => ({text: x, keyRange: this._KeyRange.only(x)}));\n\n\t\treturn new IFTSArrayPromise(this.db.indexes, Promise.all(flatten(columns.map(col => {\n\t\t\tconst index = this.transaction.objectStore(this.db.index_prefix + 'word_' + col).index('word');\n\n\t\t\treturn queries.map(query => this._readCursor(index.openCursor(query.keyRange), null, data => [data.key, query.text]));\n\t\t}))).then(candidates => {\n\t\t\tcandidates = dedup(flatten(candidates));\n\n\t\t\tconst counts = {};\n\t\t\tfor (let i=0; i<candidates.length; i++) {\n\t\t\t\tconst key = candidates[i][0];\n\t\t\t\tif (!(key in counts)) {\n\t\t\t\t\tcounts[key] = 0;\n\t\t\t\t}\n\t\t\t\tcounts[key]++;\n\t\t\t}\n\n\t\t\tconst hits = new Array(candidates.length);\n\t\t\tlet hits_count = 0;\n\t\t\tfor (let i=0; i<candidates.length; i++) {\n\t\t\t\tconst key = candidates[i][0];\n\t\t\t\tif (counts[key] >= queries.length) {\n\t\t\t\t\thits[hits_count] = key;\n\t\t\t\t\thits_count++;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst result = new Array(hits_count);\n\t\t\tfor (let i=0; i<hits_count; i++) {\n\t\t\t\tresult[i] = this.get(hits[i]);\n\t\t\t}\n\t\t\treturn new IFTSArrayPromise(this.db.indexes, Promise.all(result));\n\t\t}));\n\t}\n\n\t/**\n\t * Get N-Gram set from index.\n\t *\n\t * @param {string} column - name of column.\n\t *\n\t * @return {Promise<Map<string, number>>}\n\t */\n\tgetNGrams(column) {\n\t\tif (!this.db.ngram_indexes.has(column)) {\n\t\t\treturn Promise.reject(new NoSuchColumnError(column));\n\t\t}\n\n\t\tconst result = new Map();\n\n\t\tconst cursor = this.transaction.objectStore(this.db.index_prefix + 'ngram_' + column).openCursor();\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tcursor.onsuccess = ev => {\n\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\tif (cursor) {\n\t\t\t\t\tresult.set(cursor.value.token, (result.get(cursor.value.token) || 0) + 1);\n\t\t\t\t\tcursor.continue();\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcursor.onerror = ev => reject(ev);\n\t\t});\n\t}\n\n\t/**\n\t * Get word set from index.\n\t *\n\t * @param {string} column - name of column.\n\t *\n\t * @return {Promise<Map<string, number>>}\n\t */\n\tgetWords(column) {\n\t\tif (!this.db.word_indexes.has(column)) {\n\t\t\treturn Promise.reject(new NoSuchColumnError(column));\n\t\t}\n\n\t\tconst result = new Map();\n\n\t\tconst cursor = this.transaction.objectStore(this.db.index_prefix + 'word_' + column).openCursor();\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tcursor.onsuccess = ev => {\n\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\tif (cursor) {\n\t\t\t\t\tresult.set(cursor.value.word, (result.get(cursor.value.word) || 0) + 1);\n\t\t\t\t\tcursor.continue();\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcursor.onerror = ev => reject(ev);\n\t\t});\n\t}\n}\n","import IFTSTransaction from './IFTSTransaction';\n\n\n/**\n * The database of IndexedFTS.\n *\n * Almost methods are the same interface as {@link IDBTransaction} and {@link IFTSArrayPromise}.\n */\nexport default class IndexedFTS {\n\t/**\n\t * Create or open IndexedFTS.\n\t *\n\t * Database has name and schema's version.\n\t * The name is a name of the database in the storage.\n\t *\n\t * The schema is an object that key is column name and value is a definition of indexes. Schema can't change in same version database.\n\t * If you want change schema of database, please change version number.\n\t * Please be careful, all contents will remove when changing the version number.\n\t *\n\t * Index types are 'primary', 'unique', 'fulltext', 'ngram', 'word', or normal index.\n\t *\n\t * 'primary' is a primary key of the database. 'primary' can't set to multiple columns.\n\t *\n\t * 'unique' is columns that have a unique value in the database.\n\t *\n\t * If set 'ngram' IndexedFTS will make 2-gram index table for full-text search.\n\t * 'fulltext' is alias to 'ngram'.\n\t *\n\t * 'word' is word based index.\n\t * The word index will split text with whitespaces and store those.\n\t * Word index is faster than the 'ngram' index but can't find a partial match in the word.\n\t *\n\t * The normal index that not set optioned that not unique, not primary, and not indexed for full-text search. You can numeric search like {@link IndexedFTS#lower} {@link IndexedFTS#between} even if not set option.\n\t *\n\t * If you want to set some index types, please use object like `{unique: true, fulltext: true}`.\n\t *\n\t * @param {string} name - name of new (or open) database.\n\t * @param {number} version - schema's version of database.\n\t * @param {Array<string|object>} schema - database schema.\n\t * @param {object} [options] - other options.\n\t * @param {string} [options.index_prefix='indexedfts_'] - prefix of indexes for full-text search.\n\t * @param {object} [options.scope=window] - endpoints for IndexedDB API.\n\t */\n\tconstructor(name, version, schema, options={}) {\n\t\t/** @type {string} */\n\t\tthis.index_prefix = options.index_prefix || 'indexedfts_';\n\n\t\t/** @type {object} */\n\t\tthis.scope = options.scope || window;\n\n\t\t/** @type {string} */\n\t\tthis.name = name;\n\n\t\t/** @type {number} */\n\t\tthis.version = version;\n\n\t\t/** @type {object} */\n\t\tthis.schema = schema;\n\n\t\t/** @type {object} */\n\t\tthis.store_option = {autoIncrement: true};\n\n\t\t/** @type {string|null} */\n\t\tthis.primary_key = null;\n\n\t\t/** @type {Set<string>} */\n\t\tthis.ngram_indexes = new Set();\n\n\t\t/** @type {Set<string>} */\n\t\tthis.word_indexes = new Set();\n\n\t\t/** @type {Set<string>} */\n\t\tthis.unique_indexes = new Set();\n\n\t\t/** @type {Set<string>} */\n\t\tthis.normal_indexes = new Set();\n\n\t\t/** @type {IDBDatabase} */\n\t\tthis.db = null;\n\n\t\tfor (let x in schema) {\n\t\t\tif (schema[x] === 'primary' || schema[x].primary) {\n\t\t\t\tif ('keyPath' in this.store_option) {\n\t\t\t\t\tthrow new Error('can not use multi primary key');\n\t\t\t\t}\n\t\t\t\tthis.primary_key = x;\n\t\t\t\tthis.store_option = {keyPath: x};\n\t\t\t} else if (schema[x] === 'unique' || schema[x].unique) {\n\t\t\t\tthis.unique_indexes.add(x);\n\t\t\t} else {\n\t\t\t\tthis.normal_indexes.add(x);\n\t\t\t}\n\n\t\t\tif (schema[x] === 'ngram' || schema[x].ngram\n\t\t\t|| schema[x] === 'fulltext' || schema[x].fulltext) {\n\t\t\t\tthis.ngram_indexes.add(x);\n\t\t\t}\n\n\t\t\tif (schema[x] === 'word' || schema[x].word) {\n\t\t\t\tthis.word_indexes.add(x);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Delete database.\n\t *\n\t * Must be close all IndexedFTS before delete database.\n\t *\n\t * @param {string} name - name of target database. this method will success even if no such database.\n\t * @param {object} [scope] - endpoints for IndexedDB API.\n\t *\n\t * @return {Promise<undefined>}\n\t */\n\tstatic delete(name, scope=null) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst req = (scope || window).indexedDB.deleteDatabase(name);\n\t\t\treq.onsuccess = ev => resolve();\n\t\t\treq.onerror = ev => reject(ev);\n\t\t});\n\t}\n\n\t/** @type {Set<string>} */\n\tget indexes() {\n\t\tconst r = new Set([...this.ngram_indexes, ...this.word_indexes, ...this.unique_indexes, ...this.normal_indexes]);\n\t\tif (this.primary_key !== null) {\n\t\t\tr.add(this.primary_key);\n\t\t}\n\t\treturn r;\n\t}\n\n\t/**\n\t * Open database.\n\t *\n\t * @return {Promise<undefined>}\n\t */\n\topen() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst request = this.scope.indexedDB.open(this.name, this.version);\n\n\t\t\trequest.onsuccess = ev => {\n\t\t\t\tthis.db = ev.target.result;\n\t\t\t\tresolve(this);\n\t\t\t};\n\t\t\trequest.onerror = reject;\n\n\t\t\trequest.onupgradeneeded = ev => {\n\t\t\t\tthis.db = ev.target.result;\n\n\t\t\t\tconst store = this.db.createObjectStore('data', this.store_option);\n\n\t\t\t\tstore.onerror = reject;\n\n\t\t\t\tthis.unique_indexes.forEach(x => store.createIndex(x, x, {unique: true}));\n\n\t\t\t\tthis.normal_indexes.forEach(x => store.createIndex(x, x, {unique: false}));\n\n\t\t\t\tthis.ngram_indexes.forEach(column => {\n\t\t\t\t\tconst fts_store = this.db.createObjectStore(this.index_prefix + 'ngram_' + column, {autoIncrement: true});\n\t\t\t\t\tfts_store.onerror = reject\n\t\t\t\t\tfts_store.createIndex('key', 'key', {unique: false});\n\t\t\t\t\tfts_store.createIndex('token', 'token', {unique: false});\n\t\t\t\t});\n\n\t\t\t\tthis.word_indexes.forEach(column => {\n\t\t\t\t\tconst fts_store = this.db.createObjectStore(this.index_prefix + 'word_' + column, {autoIncrement: true});\n\t\t\t\t\tfts_store.onerror = reject\n\t\t\t\t\tfts_store.createIndex('key', 'key', {unique: false});\n\t\t\t\t\tfts_store.createIndex('word', 'word', {unique: false});\n\t\t\t\t});\n\t\t\t};\n\t\t});\n\t}\n\n\t/**\n\t * Close database.\n\t */\n\tclose() {\n\t\tthis.db.close();\n\t}\n\n\t/**\n\t * Make new {@link IFTSTransaction}.\n\t *\n\t * @param {\"readonly\"|\"readwrite\"} mode - mode of transaction.\n\t * @param {string[]|null} target - open index targets. open for all if null.\n\t *\n\t * @return {IFTSTransaction}\n\t */\n\ttransaction(mode='readonly', target=null) {\n\t\tif (target === null) {\n\t\t\tconst ngrams = [...this.ngram_indexes].map(x => this.index_prefix + 'ngram_' + x);\n\t\t\tconst words = [...this.word_indexes].map(x => this.index_prefix + 'word_' + x);\n\t\t\ttarget = ngrams.concat(words).concat(['data']);\n\t\t}\n\t\treturn new IFTSTransaction(this, this.db.transaction(target, mode));\n\t}\n\n\t/**\n\t * Put contents into database.\n\t *\n\t * @param {object} contents - contents for save. allowed multiple arguments.\n\t *\n\t * @return {Promise<IndexedFTS>} returns self for chain.\n\t */\n\tput(...contents) {\n\t\treturn this.transaction('readwrite').put(...contents).then(() => this);\n\t}\n\n\t/**\n\t * Delete contents from database.\n\t *\n\t * @param {object} keys - key of contents.\n\t *\n\t * @return {Promise<IndexedFTS>} returns self for chain. Will reject with {@link InvalidKeyError} if keys included null or undefined.\n\t */\n\tdelete(...keys) {\n\t\treturn this.transaction('readwrite').delete(...keys).then(() => this);\n\t}\n\n\t/**\n\t * Get content by primary key.\n\t *\n\t * @param {object} key - the key of content.\n\t *\n\t * @return {Promise<object|undefined>} content. promise will reject with {@link InvalidKeyError} if keys included null or undefined. result value will be undefined if not found.\n\t */\n\tget(key) {\n\t\treturn this.transaction('readonly', 'data').get(key);\n\t}\n\n\t/**\n\t * Get filtered contents.\n\t *\n\t * @ignore\n\t */\n\t_getFiltered(fun) {\n\t\treturn fun(this.transaction('readonly', 'data'));\n\t}\n\n\t/**\n\t * Get all contents.\n\t *\n\t * @return {IFTSArrayPromise} contents.\n\t */\n\tgetAll() {\n\t\treturn this._getFiltered(x => x.getAll());\n\t}\n\n\t/**\n\t * Do something process for each elements and returns {@link IFTSArrayPromise}.\n\t *\n\t * NOTE: This method doesn't fast. May better do filtering before doing map if need filtering.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for processing element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tmap(fun) {\n\t\treturn this._getFiltered(x => x.map(fun));\n\t}\n\n\t/**\n\t * Filtering elements by function and returns {@link IFTSArrayPromise}.\n\t *\n\t * WARNING: This method won't use the index. Other methods(eg. {@link IFTSTransaction#equals or @link IFTSTransaction#lower} may faster than this.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for filtering element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tfilter(fun) {\n\t\treturn this._getFiltered(x => x.filter(fun));\n\t}\n\n\t/**\n\t * Sort and get all contents.\n\t *\n\t * @param {object} column - the column for sorting.\n\t * @param {'asc'|'desc'} [order='asc'] - sort order.\n\t * @param {Number} [offset=0] - starting offset of the result.\n\t * @param {Number} [limit] - maximum number of result length. will unlimited if omitted.\n\t *\n\t * @return {IFTSArrayPromise} sorted contents.\n\t */\n\tsort(column, order='asc', offset=0, limit=undefined) {\n\t\treturn this._getFiltered(x => x.sort(column, order, offset, limit));\n\t}\n\n\t/**\n\t * Get contents that have fully matched property.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tequals(column, value) {\n\t\treturn this._getFiltered(x => x.equals(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property lower than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlower(column, value) {\n\t\treturn this._getFiltered(x => x.lower(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property greater than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreater(column, value) {\n\t\treturn this._getFiltered(x => x.greater(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property lower than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlowerOrEquals(column, value) {\n\t\treturn this._getFiltered(x => x.lowerOrEquals(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property greater than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreaterOrEquals(column, value) {\n\t\treturn this._getFiltered(x => x.greaterOrEquals(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property is between argument values.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} lower - minimal value.\n\t * @param {object} upper - maximum value.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tbetween(column, lower, upper) {\n\t\treturn this._getFiltered(x => x.between(column, lower, upper));\n\t}\n\n\t/**\n\t * Get contents that have matched property by full-text search.\n\t *\n\t * All target columns have to made ngram index when created database.\n\t * If you didn't made ngram index, you can use {@link IFTSArrayPromise#search} (but this way is very slow).\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearch(columns, query) {\n\t\treturn this.transaction().search(columns, query);\n\t}\n\n\t/**\n\t * Find contents that have fully matched word in property.\n\t *\n\t * All target columns have to made word index when created database.\n\t * If you didn't made word index, you can use {@link IFTSArrayPromise#searchWord} (but this way is very slow).\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearchWord(columns, query) {\n\t\treturn this.transaction().searchWord(columns, query);\n\t}\n\n\t/**\n\t * Get N-Gram set from index.\n\t *\n\t * @param {string} column - name of column.\n\t *\n\t * @return {Promise<Map<string, number>>}\n\t */\n\tgetNGrams(column) {\n\t\treturn this.transaction().getNGrams(column);\n\t}\n\n\t/**\n\t * Get word set from index.\n\t *\n\t * @param {string} column - name of column.\n\t *\n\t * @return {Promise<Map<string, number>>}\n\t */\n\tgetWords(column) {\n\t\treturn this.transaction().getWords(column);\n\t}\n}\n","import {InvalidSchemaError} from './errors';\n\n\nfunction normalize(schema) {\n\tconst allowedOptions = new Set(['primary', 'unique', 'ngram', 'fulltext', 'word']);\n\n\tconst result = {};\n\tfor (const col in schema) {\n\t\tresult[col] = {\n\t\t\tprimary: schema[col] === 'primary' || schema[col].primary,\n\t\t\tunique: schema[col] === 'unique' || schema[col].unique,\n\t\t\tngram: schema[col] === 'ngram' || schema[col].ngram,\n\t\t\tfulltext: schema[col] === 'fulltext' || schema[col].fulltext,\n\t\t\tword: schema[col] === 'word' || schema[col].word,\n\t\t};\n\n\t\tif (typeof schema[col] === 'object') {\n\t\t\tfor (const opt in schema[col]) {\n\t\t\t\tif (!allowedOptions.has(opt)) {\n\t\t\t\t\tthrow new InvalidSchemaError(opt + ' is unknown option', col);\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (typeof schema[col] === 'string') {\n\t\t\tif (!allowedOptions.has(schema[col])) {\n\t\t\t\tthrow new InvalidSchemaError(schema[col] + ' is unknown option', col);\n\t\t\t}\n\t\t} else {\n\t\t\tthrow new InvalidSchemaError((typeof schema[col]) + ' is invalid option type', col);\n\t\t}\n\t}\n\treturn result;\n}\n\n\nfunction schemaCheck(schema) {\n\tlet primaryKey = null;\n\n\tfor (const col in schema) {\n\t\tif (schema[col].primary !== undefined) {\n\t\t\tif (typeof schema[col].primary !== 'boolean') {\n\t\t\t\tthrow new InvalidSchemaError('\"primary\" option must be boolean', col);\n\t\t\t}\n\t\t\tif (schema[col].primary) {\n\t\t\t\tif (primaryKey !== null) {\n\t\t\t\t\tthrow new InvalidSchemaError('can not use multiple primary key', [col, primaryKey]);\n\t\t\t\t}\n\t\t\t\tprimaryKey = col;\n\t\t\t}\n\t\t}\n\n\t\tif (schema[col].unique !== undefined) {\n\t\t\tif (typeof schema[col].unique !== 'boolean') {\n\t\t\t\tthrow new InvalidSchemaError('\"unique\" option must be boolean', col);\n\t\t\t}\n\t\t}\n\n\t\tif (schema[col].primary && schema[col].unique) {\n\t\t\tthrow new InvalidSchemaError('can not enable both of \"primary\" option and \"unique\" option to same column', col);\n\t\t}\n\n\t\tif (schema[col].ngram !== undefined && schema[col].fulltext !== undefined) {\n\t\t\tthrow new InvalidSchemaError('can not set both of \"ngram\" option and \"fulltext\" option to same column', col);\n\t\t}\n\t\tconst fts = schema[col].ngram === undefined ? schema[col].fulltext : schema[col].ngram;\n\t\tconst ftsFrom = schema[col].ngram === undefined ? 'fulltext' : 'ngram';\n\t\tif (fts !== undefined && typeof fts !== 'boolean') {\n\t\t\tthrow new InvalidSchemaError(`\"${ftsFrom}\" option must be boolean`, col);\n\t\t}\n\n\t\tif (schema[col].word !== undefined && typeof schema[col].word !== 'boolean') {\n\t\t\tthrow new InvalidSchemaError('\"word\" option must be boolean', col);\n\t\t}\n\t}\n}\n\n\n/**\n * The database schema of IndexedFTS.\n */\nexport default class IFTSSchema {\n\t/**\n\t * Create IFTSSchema.\n\t *\n\t * @param {object} schema - please see same name param of {@link IndexedFTS#constructor}.\n\t *\n\t * @throws {InvalidSchemaError}\n\t */\n\tconstructor(schema) {\n\t\t/** @ignore */\n\t\tthis._rawSchema = schema;\n\n\t\t/** @ignore */\n\t\tthis._storeOption = {autoIncrement: true};\n\n\t\t/**\n\t\t * Primary key of this schema.\n\t\t *\n\t\t * This value will be null if not set primary key.\n\t\t *\n\t\t * @type {string|null}\n\t\t */\n\t\tthis.primaryKey = null;\n\n\t\t/**\n\t\t * Column names that indexed with ngram for full-text search.\n\t\t *\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.ngramIndexes = new Set();\n\n\t\t/**\n\t\t * Column names that indexed with word for full-text search.\n\t\t *\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.wordIndexes = new Set();\n\n\t\t/**\n\t\t * Column names that unique indexed.\n\t\t *\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.uniqueIndexes = new Set();\n\n\t\t/**\n\t\t * Column names that normal indexed.\n\t\t *\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.normalIndexes = new Set();\n\n\t\tfor (let x in schema) {\n\t\t\tconst normalized = normalize(schema);\n\n\t\t\tschemaCheck(normalized);\n\n\t\t\tif (normalized[x].primary) {\n\t\t\t\tthis.primaryKey = x;\n\t\t\t\tthis._storeOption = {keyPath: x};\n\t\t\t} else if (normalized[x].unique) {\n\t\t\t\tthis.uniqueIndexes.add(x);\n\t\t\t} else {\n\t\t\t\tthis.normalIndexes.add(x);\n\t\t\t}\n\n\t\t\tif (normalized[x].ngram || normalized[x].fulltext) {\n\t\t\t\tthis.ngramIndexes.add(x);\n\t\t\t}\n\n\t\t\tif (normalized[x].word) {\n\t\t\t\tthis.wordIndexes.add(x);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * All column names that indexed in some way.\n\t *\n\t * @type {Set<string>}\n\t */\n\tget indexes() {\n\t\tif (this.primaryKey) {\n\t\t\treturn new Set([this.primaryKey, ...this.uniqueIndexes, ...this.normalIndexes]);\n\t\t} else {\n\t\t\treturn new Set([...this.uniqueIndexes, ...this.normalIndexes]);\n\t\t}\n\t}\n}\n"],"names":["splitText","text","ngram","result","i","length","push","slice","splitWords","dedup","split","filter","x","tokenize","splitQuery","query","q","forEach","array","Array","index","Set","idx","has","add","fastMap","fun","flatten","j","NoSuchColumnError","Error","column","name","captureStackTrace","InvalidKeyError","key","InvalidSchemaError","reason","IFTSArrayPromise","indexes","promise","resolve","value","Promise","reject","then","catch","xs","map","order","offset","limit","undefined","prototype","concat","call","sort","y","_checkAndFilter","lower","upper","columns","c","queries","data","every","some","col","includes","IFTSTransaction","db","transaction","_KeyRange","scope","IDBKeyRange","oncomplete","onerror","err","_cache","contents","store","objectStore","ngram_indexes","index_prefix","word_indexes","putPromises","req","put","onsuccess","ev","_updateNGramIndex","target","_updateWordIndex","all","primary_key","_key","_deleteIndex","tokens","promises","words","tableNames","table","requests","openKeyCursor","only","cursor","d","delete","primaryKey","continue","keys","cursorRequest","_readCursor","openCursor","request","offsetFilter","get","keyRange","_getAllWithIndex","upperBound","lowerBound","bound","_getAllWithKeys","candidate","founds","deduped","dedup_num","hit_count","candidates","candidate_num","_pruneCandidates","queries_num","result_num","size","queries_length","candidatePromises","apply","_takeCandidatesBySingleColumn","counts","hits","hits_count","Map","set","token","word","IndexedFTS","version","schema","options","window","store_option","autoIncrement","unique_indexes","normal_indexes","primary","keyPath","unique","fulltext","indexedDB","deleteDatabase","r","open","onupgradeneeded","createObjectStore","createIndex","fts_store","close","mode","ngrams","_getFiltered","getAll","equals","greater","lowerOrEquals","greaterOrEquals","between","search","searchWord","getNGrams","getWords","normalize","allowedOptions","opt","schemaCheck","fts","ftsFrom","IFTSSchema","_rawSchema","_storeOption","ngramIndexes","wordIndexes","uniqueIndexes","normalIndexes","normalized"],"mappings":"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"}