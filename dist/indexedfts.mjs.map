{"version":3,"file":"indexedfts.mjs","sources":["../lib/utils.js","../lib/errors.js","../lib/ArrayPromise.js","../lib/Transaction.js","../lib/Schema.js","../lib/IndexedFTS.js"],"sourcesContent":["/**\n * Splitting text to n-gram\n *\n * @ignore\n */\nexport function splitText(text, ngram=2) {\n\tconst result = [];\n\tfor (let i=0; i<text.length-ngram+1; i++) {\n\t\tresult.push(text.slice(i, i+ngram));\n\t}\n\treturn result;\n}\n\n\n/**\n * Splitting text to words\n *\n * @ignore\n */\nexport function splitWords(text) {\n\treturn dedup(text.split(/\\s+/).filter(x => x.length > 0));\n}\n\n\n/**\n * Make n-gram set by text.\n *\n * @ignore\n */\nexport function tokenize(text, ngram=2) {\n\treturn dedup(splitText(text, ngram));\n}\n\n\n/**\n * Parse queries.\n *\n * @ignore\n */\nexport function splitQuery(query, ngram=2) {\n\tconst result = {};\n\tquery.split(/\\s+/).filter(q => q.length > 0).forEach(q => result[q] = tokenize(q, ngram));\n\treturn result;\n}\n\n\n/**\n * Deduplication from Array\n *\n * @ignore\n */\nexport function dedup(array) {\n\tconst result = new Array(array.length);\n\tconst index = new Set();\n\tlet idx = 0;\n\n\tfor (let i=0; i<array.length; i++) {\n\t\tif (!index.has(array[i])) {\n\t\t\tindex.add(array[i]);\n\t\t\tresult[idx] = array[i];\n\t\t\tidx++;\n\t\t}\n\t}\n\n\treturn result.slice(0, idx);\n}\n\n\n/**\n * Faster Array.prototype.map\n *\n * @ignore\n */\nexport function fastMap(array, fun) {\n\tconst result = new Array(array.length);\n\tfor (let i=0; i<array.length; i++) {\n\t\tresult[i] = fun(array[i]);\n\t}\n\treturn result;\n}\n\n\n/**\n * Flatten nested array\n *\n * @ignore\n */\nexport function flatten(array) {\n\tlet length = 0;\n\tfor (let i=0; i<array.length; i++) {\n\t\tlength += array[i].length;\n\t}\n\n\tconst result = new Array(length);\n\tlet idx = 0;\n\tfor (let i=0; i<array.length; i++) {\n\t\tfor (let j=0; j<array[i].length; j++) {\n\t\t\tresult[idx] = array[i][j];\n\t\t\tidx++;\n\t\t}\n\t}\n\n\treturn result;\n}\n","/**\n * NoSuchColumnError means specified no indexed column.\n */\nexport class NoSuchColumnError extends Error {\n\t/**\n\t * @param {object} column - name of errored column.\n\t */\n\tconstructor(column) {\n\t\tsuper(column + ': no such column or no indexed');\n\n\t\t/**\n\t\t * Column name that errored.\n\t\t *\n\t\t * @type {object}\n\t\t */\n\t\tthis.column = column;\n\n\t\t/** @ignore */\n\t\tthis.name = '';\n\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, NoSuchColumnError);\n\t\t}\n\t}\n}\n\n\n/**\n * InvalidKeyError means specified invalid key.\n */\nexport class InvalidKeyError extends Error {\n\t/**\n\t * @param {object} key - name of specified key.\n\t */\n\tconstructor(key) {\n\t\tsuper('invalid key');\n\n\t\t/**\n\t\t * Key name that specified.\n\t\t *\n\t\t * @type {object}\n\t\t */\n\t\tthis.key = key;\n\n\t\t/** @ignore */\n\t\tthis.name = '';\n\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, InvalidKeyError);\n\t\t}\n\t}\n}\n\n\n/**\n * InvalidSchemaError means specified invalid schema.\n */\nexport class InvalidSchemaError extends Error {\n\t/**\n\t * @param {string} reason - why throws this error.\n\t * @param {string|string[]|null} column - name of column that invalid.\n\t */\n\tconstructor(reason, column=null) {\n\t\tsuper(reason);\n\n\t\t/**\n\t\t * Name of column that invalid.\n\t\t *\n\t\t * @type {string|string[]|null}\n\t\t */\n\t\tthis.column = column;\n\n\t\t/** @ignore */\n\t\tthis.name = 'InvalidSchemaError';\n\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, InvalidSchemaError);\n\t\t}\n\t}\n}\n","import {splitQuery, splitWords} from './utils';\nimport {NoSuchColumnError} from './errors';\n\n\n/**\n * Promise like object for contents array.\n *\n * Almost methods are the same interface as {@link IndexedFTS} and {@link IFTSTransaction}.\n * But this class will processing all contents without using indexes.\n * Please consider using {@link IFTSTransaction} directly if it can.\n */\nexport default class IFTSArrayPromise {\n\t/**\n\t * @param {Set<string>} indexes - index names.\n\t * @param {Promise<object[]>} promise - Promise for wrapping.\n\t */\n\tconstructor(indexes, promise) {\n\t\t/** @type {Set<string>} */\n\t\tthis.indexes = indexes;\n\n\t\t/** @type {Promise<object[]>} */\n\t\tthis.promise = promise;\n\t}\n\n\t/**\n\t * Make resolved promise.\n\t *\n\t * @param {Set<string>} indexes - index names.\n\t * @param {object[]} value - value for promise.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tstatic resolve(indexes, value=[]) {\n\t\treturn new IFTSArrayPromise(indexes, Promise.resolve(value));\n\t}\n\n\t/**\n\t * Make rejected promise.\n\t *\n\t * @param {Set<string>} indexes - index names.\n\t * @param {object} value - value for promise.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tstatic reject(indexes, value=null) {\n\t\treturn new IFTSArrayPromise(indexes, Promise.reject(value));\n\t}\n\n\t/**\n\t * Set next function.\n\t *\n\t * @param {function(contents: object[]): *} fun - next function.\n\t *\n\t * @return {Promise}\n\t */\n\tthen(fun) {\n\t\treturn this.promise.then(fun);\n\t}\n\n\t/**\n\t * Set error handling function.\n\t *\n\t * @param {function(error: *): *} fun - error handling function.\n\t *\n\t * @return {Promise}\n\t */\n\tcatch(fun) {\n\t\treturn this.promise.catch(fun);\n\t}\n\n\t/**\n\t * Do something process for each elements and make a new IFTSArrayPromise.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for processing element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tmap(fun) {\n\t\treturn new IFTSArrayPromise(this.indexes, this.then(xs => xs.map(fun)));\n\t}\n\n\t/**\n\t * Filtering elements by function and make a new IFTSArrayPromise.\n\t *\n\t * @param {function(content: object, index: Number): boolean} fun - function for filtering element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tfilter(fun) {\n\t\treturn new IFTSArrayPromise(this.indexes, this.then(xs => xs.filter(fun)));\n\t}\n\n\t/**\n\t * Sort contents.\n\t *\n\t * @param {object} column - the column for sorting.\n\t * @param {'asc'|'desc'} [order='asc'] - sort order.\n\t * @param {Number} [offset=0] - starting offset of the result.\n\t * @param {Number} [limit] - maximum number of result length. will unlimited if omitted.\n\t *\n\t * @return {IFTSArrayPromise} sorted contents.\n\t */\n\tsort(column, order='asc', offset=0, limit=undefined) {\n\t\tif (!this.indexes.has(column)) {\n\t\t\treturn IFTSArrayPromise.reject(this.indexes, new NoSuchColumnError(column));\n\t\t}\n\n\t\treturn new IFTSArrayPromise(this.indexes, this.then(xs => Array.prototype.concat.call([], xs).sort((x, y) => {\n\t\t\tif (x[column] < y[column]) {\n\t\t\t\treturn order === 'desc' ? 1 : -1;\n\t\t\t} else if (x[column] > y[column]) {\n\t\t\t\treturn order === 'desc' ? -1 : 1;\n\t\t\t} else {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t}).slice(offset, limit === undefined ? undefined : offset + limit)));\n\t}\n\n\t/**\n\t * Checking index of column are exists and do {@link IFTSArrayPromise#filter}.\n\t *\n\t * @ignore\n\t */\n\t_checkAndFilter(column, fun) {\n\t\tif (!this.indexes.has(column)) {\n\t\t\treturn IFTSArrayPromise.reject(this.indexes, new NoSuchColumnError(column));\n\t\t}\n\n\t\treturn this.filter(fun);\n\t}\n\n\t/**\n\t * Get contents that have fully matched property.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tequals(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] === value);\n\t}\n\n\t/**\n\t * Get contents that have property lower than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlower(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] < value);\n\t}\n\n\t/**\n\t * Get contents that have property greater than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreater(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] > value);\n\t}\n\n\t/**\n\t * Get contents that have property lower than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlowerOrEquals(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] <= value);\n\t}\n\n\t/**\n\t * Get contents that have property greater than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreaterOrEquals(column, value) {\n\t\treturn this._checkAndFilter(column, x => x[column] >= value);\n\t}\n\n\t/**\n\t * Get contents that have property is between argument values.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} lower - minimal value.\n\t * @param {object} upper - maximum value.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tbetween(column, lower, upper) {\n\t\treturn this._checkAndFilter(column, x => lower <= x[column] && x[column] <= upper);\n\t}\n\n\t/**\n\t * Get contents that have matched property by full-text search.\n\t *\n\t * This method can search even if didn't made ngram index.\n\t *\n\t * WARNING: This method always processes all contents without using indexes.\n\t * Please consider using {@link IFTSTransaction#search}.\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case if true. default is false.\n\t *\n\t * @return {IFTSArrayPromise} matched contents.\n\t */\n\tsearch(columns, query, options={}) {\n\t\tif (typeof columns === 'string') {\n\t\t\tcolumns = [columns];\n\t\t}\n\n\t\tfor (let c of columns) {\n\t\t\tif (!this.indexes.has(c)) {\n\t\t\t\treturn IFTSArrayPromise.reject(this.indexes, new NoSuchColumnError(c));\n\t\t\t}\n\t\t}\n\n\t\tquery = options.ignoreCase ? query.toLowerCase() : query;\n\t\tconst queries = [];\n\t\tfor (let q in splitQuery(query)) {\n\t\t\tqueries.push(q);\n\t\t}\n\n\t\tconst toLowerIfNeed = options.ignoreCase ? (x => x.toLowerCase()) : (x => x);\n\n\t\treturn this.filter(data => queries.every(q => columns.some(col => toLowerIfNeed(data[col]).includes(q))));\n\t}\n\n\t/**\n\t * Find contents that have fully matched word in property.\n\t *\n\t * This method can search even if didn't made word index.\n\t *\n\t * WARNING: This method always processes all contents without using indexes.\n\t * Please consider using {@link IFTSTransaction#searchWord}.\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case if true. default is false.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearchWord(columns, query, options={}) {\n\t\tif (typeof columns === 'string') {\n\t\t\tcolumns = [columns];\n\t\t}\n\n\t\tfor (let c of columns) {\n\t\t\tif (!this.indexes.has(c)) {\n\t\t\t\treturn IFTSArrayPromise.reject(this.indexes, new NoSuchColumnError(c));\n\t\t\t}\n\t\t}\n\n\t\tquery = options.ignoreCase ? query.toLowerCase() : query;\n\t\tconst queries = splitWords(query);\n\n\t\tconst toLowerIfNeed = options.ignoreCase ? (x => x.toLowerCase()) : (x => x);\n\n\t\treturn this.filter(data => queries.every(q => columns.some(col => {\n\t\t\treturn splitWords(toLowerIfNeed(data[col])).includes(q);\n\t\t})));\n\t}\n}\n","import {tokenize, splitQuery, splitWords, fastMap, flatten, dedup} from './utils';\nimport {NoSuchColumnError, InvalidKeyError} from './errors';\nimport IFTSArrayPromise from './ArrayPromise';\n\n\n/**\n * Transaction.\n *\n * Almost methods are the same interface as {@link IndexedFTS} and {@link IFTSArrayPromise}.\n * Probably this class is faster than other classes in most cases.\n *\n * Please be careful, IFTSTransaction are sometimes makes a big cache.\n * Should not keep many transactions if not need.\n */\nexport default class IFTSTransaction {\n\t/**\n\t * @param {IndexedFTS} db - database.\n\t * @param {IDBTransaction} transaction - transaction of IndexedDB.\n\t */\n\tconstructor(db, transaction) {\n\t\t/** @type {IndexedDB} */\n\t\tthis.db = db;\n\n\t\t/** @type {IDBTransaction} */\n\t\tthis.transaction = transaction;\n\n\t\t/** @ignore */\n\t\tthis._KeyRange = this.db.scope.IDBKeyRange;\n\n\t\t/**\n\t\t * Promise for await closing transaction.\n\t\t *\n\t\t * @type {Promise<IndexedDB>}\n\t\t */\n\t\tthis.promise = new Promise((resolve, reject) => {\n\t\t\tthis.transaction.oncomplete = () => resolve(this.db);\n\t\t\tthis.transaction.onerror = err => reject(err);\n\t\t});\n\n\t\t/** @ignore */\n\t\tthis._cache = {};\n\t}\n\n\t/**\n\t * Put contents into database.\n\t *\n\t * @param {object} contents - contents for save. allowed multiple arguments.\n\t *\n\t * @return {Promise<IFTSTransaction>} returns self for chain.\n\t */\n\tput(...contents) {\n\t\tconst store = this.transaction.objectStore('data');\n\t\tconst ngram_indexes = fastMap([...this.db.schema.ngramIndexes], column => ({name: column, store: this.transaction.objectStore(this.db.index_prefix + 'ngram_' + column)}));\n\t\tconst word_indexes = fastMap([...this.db.schema.wordIndexes], column => ({name: column, store: this.transaction.objectStore(this.db.index_prefix + 'word_' + column)}));\n\n\t\tconst putPromises = new Array(contents.length);\n\t\tfor (let i=0; i<contents.length; i++) {\n\t\t\tputPromises[i] = new Promise((resolve, reject) => {\n\t\t\t\tconst req = store.put(contents[i]);\n\t\t\t\treq.onerror = reject;\n\t\t\t\treq.onsuccess = ev => {\n\t\t\t\t\tresolve(\n\t\t\t\t\t\tthis._updateNGramIndex(ev.target.result, contents[i], ngram_indexes)\n\t\t\t\t\t\t\t.then(() => this._updateWordIndex(ev.target.result, contents[i], word_indexes)))\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\treturn Promise.all(putPromises).then(data => {\n\t\t\tfor (let i=0; i<data.length; i++) {\n\t\t\t\tconst key = data[i][0];\n\t\t\t\tconst value = data[i][1];\n\t\t\t\tif (this.db.schema.primaryKey === null) {\n\t\t\t\t\tvalue._key = key;\n\t\t\t\t}\n\t\t\t\tthis._cache[key] = value;\n\t\t\t}\n\t\t\treturn this;\n\t\t});\n\t}\n\n\t/**\n\t * Update ngram index.\n\t *\n\t * @ignore\n\t */\n\t_updateNGramIndex(key, data, ngram_indexes) {\n\t\treturn this._deleteIndex(key, ngram_indexes.map(x => this.db.index_prefix + 'ngram_' + x.name))\n\t\t\t.then(() => Promise.all(fastMap(ngram_indexes, col => {\n\t\t\t\tconst tokens = tokenize(data[col.name]);\n\t\t\t\tconst promises = new Array(tokens.length);\n\t\t\t\tfor (let i=0; i<tokens.length; i++) {\n\t\t\t\t\tpromises[i] = new Promise((resolve, reject) => {\n\t\t\t\t\t\tconst req = col.store.put({\n\t\t\t\t\t\t\tkey: key,\n\t\t\t\t\t\t\ttoken: tokens[i],\n\t\t\t\t\t\t\tlower: tokens[i].toLowerCase(),\n\t\t\t\t\t\t});\n\t\t\t\t\t\treq.onsuccess = () => resolve();\n\t\t\t\t\t\treq.onerror = reject;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn Promise.all(promises);\n\t\t\t})))\n\t\t\t.then(() => [key, data]);\n\t}\n\n\t/**\n\t * Update word index.\n\t *\n\t * @ignore\n\t */\n\t_updateWordIndex(key, data, word_indexes) {\n\t\treturn this._deleteIndex(key, word_indexes.map(x => this.db.index_prefix + 'word_' + x.name))\n\t\t\t.then(() => Promise.all(fastMap(word_indexes, col => {\n\t\t\t\tconst words = splitWords(data[col.name]);\n\t\t\t\tconst promises = new Array(words.length);\n\t\t\t\tfor (let i=0; i<words.length; i++) {\n\t\t\t\t\tpromises[i] = new Promise((resolve, reject) => {\n\t\t\t\t\t\tconst req = col.store.put({\n\t\t\t\t\t\t\tkey: key,\n\t\t\t\t\t\t\tword: words[i],\n\t\t\t\t\t\t\tlower: words[i].toLowerCase(),\n\t\t\t\t\t\t});\n\t\t\t\t\t\treq.onsuccess = () => resolve();\n\t\t\t\t\t\treq.onerror = reject;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn Promise.all(promises);\n\t\t\t})))\n\t\t\t.then(() => [key, data]);\n\t}\n\n\t/**\n\t * Delete content by FTS indexes of database.\n\t *\n\t * @ignore\n\t */\n\t_deleteIndex(key, tableNames) {\n\t\treturn Promise.all(tableNames.map(table => {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst store = this.transaction.objectStore(table);\n\t\t\t\tstore.onerror = reject;\n\n\t\t\t\tconst requests = [];\n\n\t\t\t\tconst req = store.index('key').openKeyCursor(this._KeyRange.only(key));\n\t\t\t\treq.onerror = reject;\n\t\t\t\treq.onsuccess = ev => {\n\t\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\t\tif (cursor) {\n\t\t\t\t\t\trequests.push(new Promise((resolve, reject) => {\n\t\t\t\t\t\t\tconst d = store.delete(cursor.primaryKey);\n\t\t\t\t\t\t\td.onsuccess = resolve;\n\t\t\t\t\t\t\td.onerror = reject\n\t\t\t\t\t\t}));\n\t\t\t\t\t\tcursor.continue();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(Promise.all(requests));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}));\n\t}\n\n\t/**\n\t * Delete contents from database.\n\t *\n\t * @param {object} keys - key of contents. allowed multiple arguments.\n\t *\n\t * @return {Promise<IFTSTransaction>} returns self for chain. Will reject with {@link InvalidKeyError} if keys included null or undefined.\n\t */\n\tdelete(...keys) {\n\t\tfor (let i=0; i<keys.length; i++) {\n\t\t\tif (keys[i] === null || keys[i] === undefined) {\n\t\t\t\treturn Promise.reject(new InvalidKeyError(keys[i]));\n\t\t\t}\n\t\t}\n\n\t\treturn Promise.all(fastMap(keys, key => {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst req = this.transaction.objectStore('data').delete(key);\n\t\t\t\treq.onerror = reject;\n\t\t\t\treq.onsuccess = resolve;\n\t\t\t})\n\t\t\t.then(() => this._deleteIndex(key, [\n\t\t\t\t...[...this.db.schema.ngramIndexes].map(x => this.db.index_prefix + 'ngram_' + x),\n\t\t\t\t...[...this.db.schema.wordIndexes].map(x => this.db.index_prefix + 'word_' + x),\n\t\t\t]))\n\t\t})).then(() => this);\n\t}\n\n\t/**\n\t * Make {@link IFTSArrayPromise} by cursor.\n\t *\n\t * @ignore\n\t */\n\t_readCursor(cursorRequest, filter=null, map=null, limit=undefined) {\n\t\tfilter = filter || ((x, i) => true);\n\t\tmap = map || ((x, i) => x);\n\n\t\treturn new IFTSArrayPromise(this.db.schema.indexes, new Promise((resolve, reject) => {\n\t\t\tconst result = [];\n\t\t\tlet index = 0;\n\n\t\t\tcursorRequest.onsuccess = ev => {\n\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\tif (cursor) {\n\t\t\t\t\tconst value = cursor.value;\n\t\t\t\t\tif (this.db.schema.primaryKey === null) {\n\t\t\t\t\t\tvalue._key = cursor.key;\n\t\t\t\t\t}\n\t\t\t\t\tthis._cache[cursor.key] = value;\n\t\t\t\t\tif (filter(value, index)) {\n\t\t\t\t\t\tresult.push(map(value, index));\n\t\t\t\t\t}\n\n\t\t\t\t\tindex++;\n\t\t\t\t\tif (limit === undefined || index < limit) {\n\t\t\t\t\t\tcursor.continue();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(result);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t};\n\t\t\tcursorRequest.onerror = err => reject(err);\n\t\t}));\n\t}\n\n\t/**\n\t * Get all contents.\n\t *\n\t * @return {IFTSArrayPromise} contents.\n\t */\n\tgetAll() {\n\t\treturn this._readCursor(this.transaction.objectStore('data').openCursor());\n\t}\n\n\t/**\n\t * Get all contents with primary keys.\n\t *\n\t * @ignore\n\t */\n\t_getAllWithKeys() {\n\t\treturn new IFTSArrayPromise(this.db.schema.indexes, new Promise((resolve, reject) => {\n\t\t\tconst request = this.transaction.objectStore('data').openCursor();\n\n\t\t\tconst result = [];\n\t\t\trequest.onsuccess = ev => {\n\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\tif (cursor) {\n\t\t\t\t\tconst value = cursor.value;\n\t\t\t\t\tif (this.db.schema.primaryKey === null) {\n\t\t\t\t\t\tvalue._key = cursor.key;\n\t\t\t\t\t}\n\t\t\t\t\tthis._cache[cursor.key] = value;\n\t\t\t\t\tresult.push({key: cursor.key, data: value});\n\t\t\t\t\tcursor.continue();\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\trequest.onerror = err => reject(err);\n\t\t}));\n\t}\n\n\t/**\n\t * Do something process for each elements and returns {@link IFTSArrayPromise}.\n\t *\n\t * NOTE: This method doesn't fast. May better do filtering before doing map if need filtering.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for processing element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tmap(fun) {\n\t\treturn this._readCursor(this.transaction.objectStore('data').openCursor(null), null, fun);\n\t}\n\n\t/**\n\t * Filtering elements by function and returns {@link IFTSArrayPromise}.\n\t *\n\t * WARNING: This method won't use the index. Other methods(eg. {@link IFTSTransaction#equals} or {@link IFTSTransaction#lower} may faster than this.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for filtering element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tfilter(fun) {\n\t\treturn this._readCursor(this.transaction.objectStore('data').openCursor(null), fun, null);\n\t}\n\n\t/**\n\t * Sort and get all contents.\n\t *\n\t * @param {object} column - the column for sorting.\n\t * @param {'asc'|'desc'} [order='asc'] - sort order.\n\t * @param {Number} [offset=0] - starting offset of the result.\n\t * @param {Number} [limit] - maximum number of result length. will unlimited if omitted.\n\t *\n\t * @return {IFTSArrayPromise} sorted contents.\n\t */\n\tsort(column, order='asc', offset=0, limit=undefined) {\n\t\tif (!this.db.schema.indexes.has(column)) {\n\t\t\treturn IFTSArrayPromise.reject(this.db.schema.indexes, new NoSuchColumnError(column));\n\t\t}\n\n\t\tlimit = limit === undefined ? undefined : offset + limit;\n\t\tconst offsetFilter = (x, i) => offset <= i;\n\n\t\tconst store = this.transaction.objectStore('data');\n\n\t\tif (column === this.db.schema.primaryKey) {\n\t\t\treturn this._readCursor(store.openCursor(null, order === 'desc' ? 'prev' : 'next'), offsetFilter, null, limit);\n\t\t} else {\n\t\t\treturn this._readCursor(store.index(column).openCursor(null, order === 'desc' ? 'prev' : 'next'), offsetFilter, null, limit);\n\t\t}\n\t}\n\n\t/**\n\t * Get content by primary key.\n\t *\n\t * @param {object} key - the key of content.\n\t *\n\t * @return {Promise<object|undefined>} content. promise will reject with {@link InvalidKeyError} if keys included null or undefined. result value will be undefined if not found.\n\t */\n\tget(key) {\n\t\tif (key === null || key === undefined) {\n\t\t\treturn Promise.reject(new InvalidKeyError(key));\n\t\t}\n\t\tif (key in this._cache) {\n\t\t\treturn Promise.resolve(this._cache[key]);\n\t\t}\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst req = this.transaction.objectStore('data').get(key);\n\t\t\treq.onsuccess = ev => {\n\t\t\t\tconst value = ev.target.result;\n\t\t\t\tif (this.db.schema.primaryKey === null) {\n\t\t\t\t\tvalue._key = key;\n\t\t\t\t}\n\t\t\t\tthis._cache[key] = value;\n\t\t\t\tresolve(value);\n\t\t\t};\n\t\t\treq.onerror = reject;\n\t\t});\n\t}\n\n\t/**\n\t * Get contents matched keyRange.\n\t *\n\t * @ignore\n\t */\n\t_getAllWithIndex(column, keyRange) {\n\t\tif (!this.db.schema.indexes.has(column)) {\n\t\t\treturn IFTSArrayPromise.reject(this.db.schema.indexes, new NoSuchColumnError(column));\n\t\t}\n\n\t\tconst store = this.transaction.objectStore('data');\n\n\t\tif (column === this.db.schema.primaryKey) {\n\t\t\treturn this._readCursor(store.openCursor(keyRange));\n\t\t} else {\n\t\t\treturn this._readCursor(store.index(column).openCursor(keyRange));\n\t\t}\n\t}\n\n\t/**\n\t * Get contents that have fully matched property.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tequals(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.only(value));\n\t}\n\n\t/**\n\t * Get contents that have property lower than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlower(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.upperBound(value, true));\n\t}\n\n\t/**\n\t * Get contents that have property greater than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreater(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.lowerBound(value, true));\n\t}\n\n\t/**\n\t * Get contents that have property lower than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlowerOrEquals(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.upperBound(value, false));\n\t}\n\n\t/**\n\t * Get contents that have property greater than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreaterOrEquals(column, value) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.lowerBound(value, false));\n\t}\n\n\t/**\n\t * Get contents that have property is between argument values.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} lower - minimal value.\n\t * @param {object} upper - maximum value.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tbetween(column, lower, upper) {\n\t\treturn this._getAllWithIndex(column, this._KeyRange.bound(lower, upper, false, false));\n\t}\n\n\t/**\n\t * Get candidates of search result.\n\t *\n\t * @ignore\n\t */\n\t_takeCandidatesBySingleColumn(column, queries, options={}) {\n\t\tconst store = this.transaction.objectStore(this.db.index_prefix + 'ngram_' + column);\n\t\tconst index = options.ignoreCase ? store.index('lower') : store.index('token');\n\t\tconst result = [];\n\n\t\tfor (let q in queries) {\n\t\t\tconst checkIncludes = (\n\t\t\t\toptions.ignoreCase\n\t\t\t\t\t? (x => x.data[column].toLowerCase().includes(q))\n\t\t\t\t\t: (x => x.data[column].includes(q))\n\t\t\t);\n\n\t\t\tif (queries[q].length === 0) {\n\t\t\t\tresult.push(this._getAllWithKeys().filter(checkIncludes).map(x => x.key).then(xs => ({query: q, keys: xs})));\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst promises = new Array(queries[q].length);\n\t\t\tfor (let i=0; i<queries[q].length; i++) {\n\t\t\t\tpromises[i] = this._readCursor(index.openCursor(queries[q][i]), null, data => data.key);\n\t\t\t}\n\n\t\t\tconst candidate = Promise.all(promises)\n\t\t\t\t.then(founds => {\n\t\t\t\t\tif (founds.length === 0) {\n\t\t\t\t\t\treturn Promise.resolve([]);\n\t\t\t\t\t}\n\n\t\t\t\t\tfounds = flatten(founds);\n\n\t\t\t\t\tconst deduped = new Array(founds.length);\n\t\t\t\t\tlet dedup_num = 0;\n\t\t\t\t\tconst hit_count = {};\n\t\t\t\t\tfor (let i=0; i<founds.length; i++) {\n\t\t\t\t\t\tif (!(founds[i] in hit_count)) {\n\t\t\t\t\t\t\thit_count[founds[i]] = 0;\n\n\t\t\t\t\t\t\tdeduped[dedup_num] = founds[i];\n\t\t\t\t\t\t\tdedup_num++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\thit_count[founds[i]]++;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst candidates = new Array(dedup_num);\n\t\t\t\t\tlet candidate_num = 0;\n\t\t\t\t\tfor (let i=0; i<dedup_num; i++) {\n\t\t\t\t\t\tif (hit_count[deduped[i]] >= queries[q].length) {\n\t\t\t\t\t\t\tcandidates[candidate_num] = this.get(deduped[i]).then(data => ({key: deduped[i], data: data}));\n\t\t\t\t\t\t\tcandidate_num++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn Promise.all(candidates.slice(0, candidate_num));\n\t\t\t\t})\n\t\t\t\t.then(xs => ({query: q, keys: xs.filter(checkIncludes).map(x => x.key)}))\n\n\t\t\tresult.push(candidate);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Prune contents by result of {@link IFTSTransaction#_takeCandidatesBySingleColumn}.\n\t *\n\t * @ignore\n\t */\n\tasync _pruneCandidates(queries_num, candidates) {\n\t\tconst keys = {};\n\n\t\tfor (let i=0; i<candidates.length; i++) {\n\t\t\tfor (let j=0; j<candidates[i].keys.length; j++) {\n\t\t\t\tif (!(candidates[i].keys[j] in keys)) {\n\t\t\t\t\tkeys[candidates[i].keys[j]] = new Set();\n\t\t\t\t}\n\t\t\t\tkeys[candidates[i].keys[j]].add(candidates[i].query);\n\t\t\t}\n\t\t}\n\n\t\tconst result = new Array(candidates.length);\n\t\tlet result_num = 0;\n\t\tfor (let key in keys) {\n\t\t\tif (keys[key].size == queries_num) {\n\t\t\t\tresult[result_num] = this.get(key);\n\t\t\t\tresult_num++;\n\t\t\t}\n\t\t}\n\n\t\treturn await Promise.all(result.slice(0, result_num));\n\t}\n\n\t/**\n\t * Get contents that have matched property by full-text search.\n\t *\n\t * All target columns have to made ngram index when created database.\n\t * If you didn't made ngram index, you can use {@link IFTSArrayPromise#search} (but this way is very slow).\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case if true. default is false.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearch(columns, query, options={}) {\n\t\tif (typeof columns === 'string') {\n\t\t\tcolumns = [columns];\n\t\t}\n\n\t\tfor (let i=0; i<columns.length; i++) {\n\t\t\tif (!this.db.schema.ngramIndexes.has(columns[i])) {\n\t\t\t\treturn IFTSArrayPromise.reject(this.db.schema.indexes, new NoSuchColumnError(columns[i]));\n\t\t\t}\n\t\t}\n\n\t\tquery = options.ignoreCase ? query.toLowerCase() : query;\n\t\tconst queries = splitQuery(query);\n\t\tlet queries_length = 0;\n\n\t\tfor (let q in queries) {\n\t\t\tqueries[q] = fastMap(queries[q], x => this._KeyRange.only(x));\n\t\t\tqueries_length++;\n\t\t}\n\n\t\tconst candidatePromises = [];\n\n\t\tfor (let i=0; i<columns.length; i++) {\n\t\t\tArray.prototype.push.apply(candidatePromises, this._takeCandidatesBySingleColumn(columns[i], queries, options));\n\t\t}\n\n\t\treturn new IFTSArrayPromise(\n\t\t\tthis.db.schema.indexes,\n\t\t\tPromise.all(candidatePromises).then(xs => this._pruneCandidates(queries_length, xs)),\n\t\t);\n\t}\n\n\t/**\n\t * Find contents that have fully matched word in property.\n\t *\n\t * All target columns have to made word index when created database.\n\t * If you didn't made word index, you can use {@link IFTSArrayPromise#searchWord} (but this way is very slow).\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case if true. default is false.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearchWord(columns, query, options={}) {\n\t\tif (typeof columns === 'string') {\n\t\t\tcolumns = [columns];\n\t\t}\n\n\t\tfor (let i=0; i<columns.length; i++) {\n\t\t\tif (!this.db.schema.wordIndexes.has(columns[i])) {\n\t\t\t\treturn IFTSArrayPromise.reject(this.db.schema.indexes, new NoSuchColumnError(columns[i]));\n\t\t\t}\n\t\t}\n\n\t\tquery = options.ignoreCase ? query.toLowerCase() : query;\n\t\tconst queries = splitWords(query).map(x => ({text: x, keyRange: this._KeyRange.only(x)}));\n\n\t\treturn new IFTSArrayPromise(this.db.schema.indexes, Promise.all(flatten(columns.map(col => {\n\t\t\tconst store = this.transaction.objectStore(this.db.index_prefix + 'word_' + col);\n\t\t\tconst index = options.ignoreCase ? store.index('lower') : store.index('word');\n\n\t\t\treturn queries.map(query => this._readCursor(index.openCursor(query.keyRange), null, data => [data.key, query.text]));\n\t\t}))).then(candidates => {\n\t\t\tcandidates = dedup(flatten(candidates));\n\n\t\t\tconst counts = {};\n\t\t\tfor (let i=0; i<candidates.length; i++) {\n\t\t\t\tconst key = candidates[i][0];\n\t\t\t\tif (!(key in counts)) {\n\t\t\t\t\tcounts[key] = 0;\n\t\t\t\t}\n\t\t\t\tcounts[key]++;\n\t\t\t}\n\n\t\t\tconst hits = new Array(candidates.length);\n\t\t\tlet hits_count = 0;\n\t\t\tfor (let i=0; i<candidates.length; i++) {\n\t\t\t\tconst key = candidates[i][0];\n\t\t\t\tif (counts[key] >= queries.length) {\n\t\t\t\t\thits[hits_count] = key;\n\t\t\t\t\thits_count++;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst result = new Array(hits_count);\n\t\t\tfor (let i=0; i<hits_count; i++) {\n\t\t\t\tresult[i] = this.get(hits[i]);\n\t\t\t}\n\t\t\treturn new IFTSArrayPromise(this.db.schema.indexes, Promise.all(result));\n\t\t}));\n\t}\n\n\t/**\n\t * Make token set from index.\n\t *\n\t * @ignore\n\t */\n\t_readIndexSet(index) {\n\t\tconst result = new Map();\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst cursor = index.openKeyCursor();\n\n\t\t\tcursor.onsuccess = ev => {\n\t\t\t\tconst cursor = ev.target.result;\n\t\t\t\tif (cursor) {\n\t\t\t\t\tresult.set(cursor.key, (result.get(cursor.key) || 0) + 1);\n\t\t\t\t\tcursor.continue();\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcursor.onerror = ev => reject(ev);\n\t\t});\n\t}\n\n\t/**\n\t * Get N-Gram set from index.\n\t *\n\t * @param {string} column - name of column.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case when make result.\n\t *\n\t * @return {Promise<Map<string, number>>}\n\t */\n\tgetNGrams(column, options={}) {\n\t\tif (!this.db.schema.ngramIndexes.has(column)) {\n\t\t\treturn Promise.reject(new NoSuchColumnError(column));\n\t\t}\n\n\t\tconst store = this.transaction.objectStore(this.db.index_prefix + 'ngram_' + column);\n\t\tconst index = options.ignoreCase ? store.index('lower') : store.index('token');\n\n\t\treturn this._readIndexSet(index);\n\t}\n\n\t/**\n\t * Get word set from index.\n\t *\n\t * @param {string} column - name of column.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case when make result.\n\t *\n\t * @return {Promise<Map<string, number>>}\n\t */\n\tgetWords(column, options={}) {\n\t\tif (!this.db.schema.wordIndexes.has(column)) {\n\t\t\treturn Promise.reject(new NoSuchColumnError(column));\n\t\t}\n\n\t\tconst store = this.transaction.objectStore(this.db.index_prefix + 'word_' + column);\n\t\tconst index = options.ignoreCase ? store.index('lower') : store.index('word');\n\n\t\treturn this._readIndexSet(index);\n\t}\n}\n","import {InvalidSchemaError} from './errors';\n\n\n/** @ignore */\nfunction normalize(schema) {\n\tconst allowedOptions = new Set(['primary', 'unique', 'normal', 'ngram', 'fulltext', 'word']);\n\n\tconst result = {};\n\tfor (const col in schema) {\n\t\tresult[col] = {};\n\n\t\tif (typeof schema[col] === 'object') {\n\t\t\tfor (const opt in schema[col]) {\n\t\t\t\tif (!allowedOptions.has(opt)) {\n\t\t\t\t\tthrow new InvalidSchemaError(opt + ' is unknown option', col);\n\t\t\t\t}\n\t\t\t\tresult[col][opt] = schema[col][opt];\n\t\t\t}\n\t\t} else if (typeof schema[col] === 'string') {\n\t\t\tif (!allowedOptions.has(schema[col])) {\n\t\t\t\tthrow new InvalidSchemaError(schema[col] + ' is unknown option', col);\n\t\t\t}\n\t\t\tresult[col][schema[col]] = true;\n\t\t} else {\n\t\t\tthrow new InvalidSchemaError((typeof schema[col]) + ' is invalid option type', col);\n\t\t}\n\t}\n\treturn result;\n}\n\n\n/** @ignore */\nfunction schemaCheck(schema) {\n\tlet primaryKey = null;\n\n\tfor (const col in schema) {\n\t\tif (schema[col].primary !== undefined) {\n\t\t\tif (typeof schema[col].primary !== 'boolean') {\n\t\t\t\tthrow new InvalidSchemaError('\"primary\" option must be boolean', col);\n\t\t\t}\n\t\t\tif (schema[col].primary) {\n\t\t\t\tif (primaryKey !== null) {\n\t\t\t\t\tthrow new InvalidSchemaError('can not use multiple primary key', [col, primaryKey]);\n\t\t\t\t}\n\t\t\t\tprimaryKey = col;\n\t\t\t}\n\t\t}\n\n\t\tif (schema[col].unique !== undefined) {\n\t\t\tif (typeof schema[col].unique !== 'boolean') {\n\t\t\t\tthrow new InvalidSchemaError('\"unique\" option must be boolean', col);\n\t\t\t}\n\t\t}\n\n\t\tif (schema[col].normal !== undefined) {\n\t\t\tif (typeof schema[col].normal !== 'boolean') {\n\t\t\t\tthrow new InvalidSchemaError('\"normal\" option must be boolean', col);\n\t\t\t}\n\t\t}\n\n\t\tif (schema[col].primary && schema[col].unique) {\n\t\t\tthrow new InvalidSchemaError('can not enable both of \"primary\" option and \"unique\" option to same column', col);\n\t\t}\n\t\tif (schema[col].primary && schema[col].normal) {\n\t\t\tthrow new InvalidSchemaError('can not enable both of \"primary\" option and \"normal\" option to same column', col);\n\t\t}\n\t\tif (schema[col].unique && schema[col].normal) {\n\t\t\tthrow new InvalidSchemaError('can not enable both of \"unique\" option and \"normal\" option to same column', col);\n\t\t}\n\n\t\tif (schema[col].ngram !== undefined && schema[col].fulltext !== undefined) {\n\t\t\tthrow new InvalidSchemaError('can not set both of \"ngram\" option and \"fulltext\" option to same column', col);\n\t\t}\n\t\tconst fts = schema[col].ngram === undefined ? schema[col].fulltext : schema[col].ngram;\n\t\tconst ftsFrom = schema[col].ngram === undefined ? 'fulltext' : 'ngram';\n\t\tif (fts !== undefined && typeof fts !== 'boolean') {\n\t\t\tthrow new InvalidSchemaError(`\"${ftsFrom}\" option must be boolean`, col);\n\t\t}\n\n\t\tif (schema[col].word !== undefined && typeof schema[col].word !== 'boolean') {\n\t\t\tthrow new InvalidSchemaError('\"word\" option must be boolean', col);\n\t\t}\n\t}\n}\n\n\nexport {normalize, schemaCheck};\n\n\n/**\n * The database schema of IndexedFTS.\n */\nexport default class IFTSSchema {\n\t/**\n\t * Create IFTSSchema.\n\t *\n\t * @param {object} schema - please see same name param of {@link IndexedFTS#constructor}.\n\t *\n\t * @throws {InvalidSchemaError}\n\t */\n\tconstructor(schema) {\n\t\t/** @ignore */\n\t\tthis._schema = normalize(schema);\n\n\t\t/** @ignore */\n\t\tthis._storeOption = {autoIncrement: true};\n\n\t\t/**\n\t\t * Primary key of this schema.\n\t\t *\n\t\t * This value will be null if not set primary key.\n\t\t *\n\t\t * @type {string|null}\n\t\t */\n\t\tthis.primaryKey = null;\n\n\t\t/**\n\t\t * Column names that indexed with ngram for full-text search.\n\t\t *\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.ngramIndexes = new Set();\n\n\t\t/**\n\t\t * Column names that indexed with word for full-text search.\n\t\t *\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.wordIndexes = new Set();\n\n\t\t/**\n\t\t * Column names that unique indexed.\n\t\t *\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.uniqueIndexes = new Set();\n\n\t\t/**\n\t\t * Column names that normal indexed.\n\t\t *\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.normalIndexes = new Set();\n\n\t\tfor (let x in schema) {\n\t\t\tschemaCheck(this._schema);\n\n\t\t\tif (this._schema[x].primary === true) {\n\t\t\t\tthis.primaryKey = x;\n\t\t\t\tthis._storeOption = {keyPath: x};\n\t\t\t} else if (this._schema[x].unique === true) {\n\t\t\t\tthis.uniqueIndexes.add(x);\n\t\t\t} else if (this._schema[x].normal !== false) {\n\t\t\t\tthis.normalIndexes.add(x);\n\t\t\t}\n\n\t\t\tif (this._schema[x].ngram || this._schema[x].fulltext) {\n\t\t\t\tthis.ngramIndexes.add(x);\n\t\t\t}\n\n\t\t\tif (this._schema[x].word) {\n\t\t\t\tthis.wordIndexes.add(x);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * All column names that indexed in some way.\n\t *\n\t * @type {Set<string>}\n\t */\n\tget indexes() {\n\t\tif (this.primaryKey) {\n\t\t\treturn new Set([this.primaryKey, ...this.uniqueIndexes, ...this.normalIndexes]);\n\t\t} else {\n\t\t\treturn new Set([...this.uniqueIndexes, ...this.normalIndexes]);\n\t\t}\n\t}\n}\n","import IFTSTransaction from './Transaction';\nimport IFTSSchema from './Schema';\n\n\n/**\n * The database of IndexedFTS.\n *\n * Almost methods are the same interface as {@link IDBTransaction} and {@link IFTSArrayPromise}.\n */\nexport default class IndexedFTS {\n\t/**\n\t * Create or open IndexedFTS.\n\t *\n\t * Database has name and schema's version.\n\t * The name is a name of the database in the storage.\n\t *\n\t * The schema is an object that key is column name and value is a definition of indexes. Schema can't change in same version database.\n\t * If you want change schema of database, please change version number.\n\t * Please be careful, all contents will remove when changing the version number.\n\t *\n\t * Index types are 'primary', 'unique', 'fulltext', 'ngram', 'word', or 'normal'.\n\t *\n\t * 'primary' is a primary key of the database. 'primary' can't set to multiple columns.\n\t * 'unique' is columns that have a unique value in the database.\n\t * The 'normal' will enable when not primary and not unique.\n\t * 'primary', 'unique' and 'normal' column can numeric search (eg. {@link IndexedFTS#lower} or {@link IndexedFTS#between}).\n\t *\n\t * If set 'ngram' IndexedFTS will make 2-gram index table for full-text search.\n\t * 'fulltext' is alias to 'ngram'.\n\t *\n\t * 'word' is word based index.\n\t * The word index will split text with whitespaces and store those.\n\t * Word index is faster than the 'ngram' index but can't find a partial match in the word.\n\t *\n\t * If you want to set some index types, please use object like `{unique: true, fulltext: true, normal: false}`.\n\t *\n\t * @param {string} name - name of new (or open) database.\n\t * @param {number} version - schema's version of database.\n\t * @param {object|IFTSSchema} schema - database schema.\n\t * @param {object} [options] - other options.\n\t * @param {string} [options.index_prefix='indexedfts_'] - prefix of indexes for full-text search.\n\t * @param {object} [options.scope=window] - endpoints for IndexedDB API.\n\t *\n\t * @throws {InvalidSchemaError}\n\t */\n\tconstructor(name, version, schema, options={}) {\n\t\t/** @type {string} */\n\t\tthis.index_prefix = options.index_prefix || 'indexedfts_';\n\n\t\t/** @type {object} */\n\t\tthis.scope = options.scope || window;\n\n\t\t/** @type {string} */\n\t\tthis.name = name;\n\n\t\t/** @type {number} */\n\t\tthis.version = version;\n\n\t\t/** @type {IFTSSchema} */\n\t\tthis.schema = schema instanceof IFTSSchema ? schema : new IFTSSchema(schema);\n\n\n\t\t/** @type {IDBDatabase} */\n\t\tthis.db = null;\n\t}\n\n\t/**\n\t * Delete database.\n\t *\n\t * Must be close all IndexedFTS before delete database.\n\t *\n\t * @param {string} name - name of target database. this method will success even if no such database.\n\t * @param {object} [scope] - endpoints for IndexedDB API.\n\t *\n\t * @return {Promise<undefined>}\n\t */\n\tstatic delete(name, scope=null) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst req = (scope || window).indexedDB.deleteDatabase(name);\n\t\t\treq.onsuccess = ev => resolve();\n\t\t\treq.onerror = ev => reject(ev);\n\t\t});\n\t}\n\n\t/**\n\t * Open database.\n\t *\n\t * @return {Promise<undefined>}\n\t */\n\topen() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst request = this.scope.indexedDB.open(this.name, this.version);\n\n\t\t\trequest.onsuccess = ev => {\n\t\t\t\tthis.db = ev.target.result;\n\t\t\t\tresolve(this);\n\t\t\t};\n\t\t\trequest.onerror = reject;\n\n\t\t\trequest.onupgradeneeded = ev => {\n\t\t\t\tthis.db = ev.target.result;\n\n\t\t\t\tconst store = this.db.createObjectStore('data', this.schema._storeOption);\n\n\t\t\t\tstore.onerror = reject;\n\n\t\t\t\tthis.schema.uniqueIndexes.forEach(x => store.createIndex(x, x, {unique: true}));\n\n\t\t\t\tthis.schema.normalIndexes.forEach(x => store.createIndex(x, x, {unique: false}));\n\n\t\t\t\tthis.schema.ngramIndexes.forEach(column => {\n\t\t\t\t\tconst fts_store = this.db.createObjectStore(this.index_prefix + 'ngram_' + column, {autoIncrement: true});\n\t\t\t\t\tfts_store.onerror = reject\n\t\t\t\t\tfts_store.createIndex('key', 'key', {unique: false});\n\t\t\t\t\tfts_store.createIndex('token', 'token', {unique: false});\n\t\t\t\t\tfts_store.createIndex('lower', 'lower', {unique: false});\n\t\t\t\t});\n\n\t\t\t\tthis.schema.wordIndexes.forEach(column => {\n\t\t\t\t\tconst fts_store = this.db.createObjectStore(this.index_prefix + 'word_' + column, {autoIncrement: true});\n\t\t\t\t\tfts_store.onerror = reject\n\t\t\t\t\tfts_store.createIndex('key', 'key', {unique: false});\n\t\t\t\t\tfts_store.createIndex('word', 'word', {unique: false});\n\t\t\t\t\tfts_store.createIndex('lower', 'lower', {unique: false});\n\t\t\t\t});\n\t\t\t};\n\t\t});\n\t}\n\n\t/**\n\t * Close database.\n\t */\n\tclose() {\n\t\tthis.db.close();\n\t}\n\n\t/**\n\t * Make new {@link IFTSTransaction}.\n\t *\n\t * @param {\"readonly\"|\"readwrite\"} mode - mode of transaction.\n\t * @param {string[]|null} target - open index targets. open for all if null.\n\t *\n\t * @return {IFTSTransaction}\n\t */\n\ttransaction(mode='readonly', target=null) {\n\t\tif (target === null) {\n\t\t\tconst ngrams = [...this.schema.ngramIndexes].map(x => this.index_prefix + 'ngram_' + x);\n\t\t\tconst words = [...this.schema.wordIndexes].map(x => this.index_prefix + 'word_' + x);\n\t\t\ttarget = ngrams.concat(words).concat(['data']);\n\t\t}\n\t\treturn new IFTSTransaction(this, this.db.transaction(target, mode));\n\t}\n\n\t/**\n\t * Put contents into database.\n\t *\n\t * @param {object} contents - contents for save. allowed multiple arguments.\n\t *\n\t * @return {Promise<IndexedFTS>} returns self for chain.\n\t */\n\tput(...contents) {\n\t\treturn this.transaction('readwrite').put(...contents).then(() => this);\n\t}\n\n\t/**\n\t * Delete contents from database.\n\t *\n\t * @param {object} keys - key of contents.\n\t *\n\t * @return {Promise<IndexedFTS>} returns self for chain. Will reject with {@link InvalidKeyError} if keys included null or undefined.\n\t */\n\tdelete(...keys) {\n\t\treturn this.transaction('readwrite').delete(...keys).then(() => this);\n\t}\n\n\t/**\n\t * Get content by primary key.\n\t *\n\t * @param {object} key - the key of content.\n\t *\n\t * @return {Promise<object|undefined>} content. promise will reject with {@link InvalidKeyError} if keys included null or undefined. result value will be undefined if not found.\n\t */\n\tget(key) {\n\t\treturn this.transaction('readonly', 'data').get(key);\n\t}\n\n\t/**\n\t * Get filtered contents.\n\t *\n\t * @ignore\n\t */\n\t_getFiltered(fun) {\n\t\treturn fun(this.transaction('readonly', 'data'));\n\t}\n\n\t/**\n\t * Get all contents.\n\t *\n\t * @return {IFTSArrayPromise} contents.\n\t */\n\tgetAll() {\n\t\treturn this._getFiltered(x => x.getAll());\n\t}\n\n\t/**\n\t * Do something process for each elements and returns {@link IFTSArrayPromise}.\n\t *\n\t * NOTE: This method doesn't fast. May better do filtering before doing map if need filtering.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for processing element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tmap(fun) {\n\t\treturn this._getFiltered(x => x.map(fun));\n\t}\n\n\t/**\n\t * Filtering elements by function and returns {@link IFTSArrayPromise}.\n\t *\n\t * WARNING: This method won't use the index. Other methods(eg. {@link IFTSTransaction#equals or @link IFTSTransaction#lower} may faster than this.\n\t *\n\t * @param {function(content: object, index: Number): object} fun - function for filtering element.\n\t *\n\t * @return {IFTSArrayPromise}\n\t */\n\tfilter(fun) {\n\t\treturn this._getFiltered(x => x.filter(fun));\n\t}\n\n\t/**\n\t * Sort and get all contents.\n\t *\n\t * @param {object} column - the column for sorting.\n\t * @param {'asc'|'desc'} [order='asc'] - sort order.\n\t * @param {Number} [offset=0] - starting offset of the result.\n\t * @param {Number} [limit] - maximum number of result length. will unlimited if omitted.\n\t *\n\t * @return {IFTSArrayPromise} sorted contents.\n\t */\n\tsort(column, order='asc', offset=0, limit=undefined) {\n\t\treturn this._getFiltered(x => x.sort(column, order, offset, limit));\n\t}\n\n\t/**\n\t * Get contents that have fully matched property.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tequals(column, value) {\n\t\treturn this._getFiltered(x => x.equals(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property lower than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlower(column, value) {\n\t\treturn this._getFiltered(x => x.lower(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property greater than value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreater(column, value) {\n\t\treturn this._getFiltered(x => x.greater(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property lower than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tlowerOrEquals(column, value) {\n\t\treturn this._getFiltered(x => x.lowerOrEquals(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property greater than value or equals value.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} value - value for search.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tgreaterOrEquals(column, value) {\n\t\treturn this._getFiltered(x => x.greaterOrEquals(column, value));\n\t}\n\n\t/**\n\t * Get contents that have property is between argument values.\n\t *\n\t * @param {object} column - column name for search.\n\t * @param {object} lower - minimal value.\n\t * @param {object} upper - maximum value.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tbetween(column, lower, upper) {\n\t\treturn this._getFiltered(x => x.between(column, lower, upper));\n\t}\n\n\t/**\n\t * Get contents that have matched property by full-text search.\n\t *\n\t * All target columns have to made ngram index when created database.\n\t * If you didn't made ngram index, you can use {@link IFTSArrayPromise#search} (but this way is very slow).\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case if true. default is false.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearch(columns, query, options={}) {\n\t\treturn this.transaction().search(columns, query, options);\n\t}\n\n\t/**\n\t * Find contents that have fully matched word in property.\n\t *\n\t * All target columns have to made word index when created database.\n\t * If you didn't made word index, you can use {@link IFTSArrayPromise#searchWord} (but this way is very slow).\n\t *\n\t *\n\t * @param {object|object[]} columns - column names for search.\n\t * @param {string} query - query for search.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case if true. default is false.\n\t *\n\t * @return {IFTSArrayPromise} matched contents. may reject with {@link NoSuchColumnError}.\n\t */\n\tsearchWord(columns, query, options={}) {\n\t\treturn this.transaction().searchWord(columns, query, options);\n\t}\n\n\t/**\n\t * Get N-Gram set from index.\n\t *\n\t * @param {string} column - name of column.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case when make result.\n\t *\n\t * @return {Promise<Map<string, number>>}\n\t */\n\tgetNGrams(column, options={}) {\n\t\treturn this.transaction().getNGrams(column, options);\n\t}\n\n\t/**\n\t * Get word set from index.\n\t *\n\t * @param {string} column - name of column.\n\t * @param {object} [options] - optional arguments.\n\t * @param {boolean} [options.ignoreCase=false] - ignore case when make result.\n\t *\n\t * @return {Promise<Map<string, number>>}\n\t */\n\tgetWords(column, options={}) {\n\t\treturn this.transaction().getWords(column, options);\n\t}\n}\n"],"names":["splitText","text","ngram","result","i","length","push","slice","splitWords","dedup","split","filter","x","tokenize","splitQuery","query","q","forEach","array","Array","index","Set","idx","has","add","fastMap","fun","flatten","j","NoSuchColumnError","Error","constructor","column","name","captureStackTrace","InvalidKeyError","key","InvalidSchemaError","reason","IFTSArrayPromise","indexes","promise","resolve","value","Promise","reject","then","catch","map","xs","sort","order","offset","limit","undefined","prototype","concat","call","y","_checkAndFilter","equals","lower","greater","lowerOrEquals","greaterOrEquals","between","upper","search","columns","options","c","ignoreCase","toLowerCase","queries","toLowerIfNeed","data","every","some","col","includes","searchWord","IFTSTransaction","db","transaction","_KeyRange","scope","IDBKeyRange","oncomplete","onerror","err","_cache","put","contents","store","objectStore","ngram_indexes","schema","ngramIndexes","index_prefix","word_indexes","wordIndexes","putPromises","req","onsuccess","ev","_updateNGramIndex","target","_updateWordIndex","all","primaryKey","_key","_deleteIndex","tokens","promises","token","words","word","tableNames","table","requests","openKeyCursor","only","cursor","d","delete","continue","keys","_readCursor","cursorRequest","getAll","openCursor","_getAllWithKeys","request","offsetFilter","get","_getAllWithIndex","keyRange","upperBound","lowerBound","bound","_takeCandidatesBySingleColumn","checkIncludes","candidate","founds","deduped","dedup_num","hit_count","candidates","candidate_num","_pruneCandidates","queries_num","result_num","size","queries_length","candidatePromises","apply","counts","hits","hits_count","_readIndexSet","Map","set","getNGrams","getWords","normalize","allowedOptions","opt","schemaCheck","primary","unique","normal","fulltext","fts","ftsFrom","IFTSSchema","_schema","_storeOption","autoIncrement","uniqueIndexes","normalIndexes","keyPath","IndexedFTS","version","window","indexedDB","deleteDatabase","open","onupgradeneeded","createObjectStore","createIndex","fts_store","close","mode","ngrams","_getFiltered"],"mappings":"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"}